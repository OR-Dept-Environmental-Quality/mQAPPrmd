---
output: 
  word_document:
    reference_docx: T:/Temperature_TMDL_Revisions/model_QAPPs/R/data/Report_Template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r, label=`setup-chap6`, include=FALSE}
knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)
options(kableExtra.auto_format = F)
options(knitr.kable.NA = '')

# for test: waterbody_name <- "North Umpqua River"

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

model.extent <- ifelse(NROW(section.model.input)>0,
                       ifelse(section.model.input$`Model Waterbody` == section.model.input$`Model Extent`, TRUE, FALSE),
                       TRUE)

model.extent <- na.omit(model.extent)

```

## `r waterbody_name`

`r if(waterbody_name == "Columbia Slough"){paste0("The Columbia Slough CE-QUAL-W2 model simulations were conducted by Portland State University to evaluate the impact of potential physical and operational changes to the Columbia Slough. The goal of the project was to aid the Oregon Department of Environmental Quality in the development of temperature TMDLs. The model was a modified version of CE-QUAL-W2 that had been applied to the Columbia Slough by Portland State University for the City of Portland Bureau of Environmental Services. ")}`

`r if(waterbody_name == "Columbia Slough"){paste0("This modified version included additional macrophyte and shading algorithms. Features of the macrophyte model include the ability to simulate multiple submerged macrophyte species; the transport of nutrient fluxes between plant biomass and the water column and/or sediments; growth limitation due to nutrient, light and temperature; the simulation of the spatial distribution of macrophytes vertically and horizontally; the modeling of light attenuation in the water column caused by macrophyte concentration; and the modeling of channel friction due to macrophytes. Macrophyte growth can significantly affect temperatures in the Columbia Slough because the greater channel friction raises water levels and increases travel time. The model also simulates groundwater inflows that were the greatest source of inflows during the dry summer months. Cool groundwater generally heats up as it flows into and eventually out of the Columbia Slough.")}`

### Model domain

```{r, label=`t6x1`, include=FALSE}

if(length(section.model.info$`Model Extent Text`)>1){
  
  model.domain <- unique(sort(section.model.info$`Model Extent Text`))
  
} else {
  
  model.domain <- section.model.info$`Model Extent Text`
  
} 

```

The extent of the model domain is the `r model.domain`

`r if(waterbody_name == "Columbia Slough"){paste0("The domain for the Columbia Slough model is shown in Figure 3 (Berger, 2003).")}`

```{r c_s, eval.after="fig.cap", fig.cap=columbia.slough, results='asis', cache=FALSE, eval=TRUE, fig.height=7, out.height='615px', echo=FALSE}

if(waterbody_name == "Columbia Slough"){
  
  columbia.slough <- figs(name="cs", caption = paste0("Columbia Slough system model domain (Berger, 2003)."))
  knitr::include_graphics(path = "./fig/Columbia_Slough.png")
  
}

```

### Spatial and temporal resolution

```{r, label=`resol`, include=FALSE}
# test: waterbody_name <-  "Columbia Slough"
data.dir <- "//deqhq1/TMDL/Planning statewide/Temperature_TMDL_Revisions/model_QAPPs/R/data/"
col.slough <- readxl::read_xlsx(paste0(data.dir,"tables.xlsx"),sheet = "LowerWillamette_ColumbiaSlough")

tbl.col.slough <- flextable::regulartable(col.slough) %>% 
  flextable::set_table_properties(layout = "autofit") %>% 
  flextable::valign(valign = "top") %>% 
  flextable::theme_box() %>% 
  flextable::set_caption(tbls(name = "col.slough",
                              caption = paste0("Model characteristics of the Columbia Slough CE-QUAL-W2 grids.")))

```

`r if(waterbody_name == "Columbia Slough"){paste0("The Columbia Slough model is composed of 397 longitudinal segments (25-231 m) and 17 vertical layers (layer height of 0.30-0.61 m) and 41 branches (separate water bodies or branches off the main stem), many of which are segregated by culverts. The number of model time step intervals (NDT) is 2 and the minimum time step (DLTMIN) is 0.025 seconds. The characteristics of the Columbia Slough model regions are shown in ", tbls(name = "col.slough", display="cite"), ". For additional details regarding model setup and resolution, see Berger and Wells 2005.")}`

`r if(!waterbody_name == "Columbia Slough"){paste0("The model input sampling rate (*dx*) is ", unique(section.model.info$"Input dx"), " ", unique(section.model.info$"Input dx Units"), ". Output is generated every ", unique(section.model.info$"Output dx"), " ", unique(section.model.info$"Output dx Units"), ". The model time step (*dt*) is ", unique(section.model.info$dT), " ", unique(section.model.info$"dT Units"),".")}`

`r if(!waterbody_name == "Columbia Slough"){paste0("A *dx* of ", unique(section.model.info$"Input dx"), " ", unique(section.model.info$"Input dx Units"), " was chosen to capture the range of solar flux input caused by the varied vegetation conditions along the length of the stream. The high resolution *dx* will allow evaluation of multiple vegetation management scenarios for each designated management agency.")}`

`r if(waterbody_name == "Columbia Slough"){tbl.col.slough}`

### Source characteristics

```{r, label=`sc`, include=FALSE}

# NPDES
npdes.ind.waterbody <- npdes.ind.pro.area %>%
  dplyr::filter(grepl(pattern=gsub("\\s*\\([^\\)]+\\)","",x=waterbody_name), x=`Stream Name`, ignore.case = TRUE)) %>% 
  dplyr::mutate(`Facility Name (Facility Number)` = paste0(`Common Name`," (", `WQ File Nbr`,")"),
                `Latitude/Longitude` = paste0(round(Latitude,4), "/",round(Longitude,3)),
                `Permit Type and Description` = paste0(`Permit Type`, ": ", `Permit Description`),
                `River Mile` = round(`River Mile`,1),
                `Stream/River Mile` = ifelse(is.na(`Stream Name`), NA, paste0(`Stream Name`, " ", " RM ",`River Mile`))) %>% 
  dplyr::select(`Facility Name (Facility Number)`, `Latitude/Longitude`,`Permit Type and Description`, `Stream/River Mile`) %>% 
  dplyr::arrange(`Facility Name (Facility Number)`)

npdes.ind.n <- nrow(npdes.ind.waterbody)

if(npdes.ind.n>0){
  
  npdes.ind.tbl <- knitr::kable(npdes.ind.waterbody, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),
                                               caption = paste0("Summary of individual NPDES permitted discharges in the ", waterbody_name, ".")))
  
}

if(npdes.ind.n == 0) {
  npdes.txt <- "There are no permitted individual NPDES point sources along the model extent."
} 

if(npdes.ind.n == 1) {
  npdes.txt <- paste0("There is one permitted individual NPDES point source along the model extent. Detail about the point source is summarized in ",tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite"), ".")
}

if(npdes.ind.n > 1) {
  npdes.txt <- paste0("There are ", numbers.to.words(npdes.ind.n)," permitted individual NPDES point sources along the model extent. Detail about each point source is summarized in ",tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite"),".")
} 

# NLCD
nlcd.waterbody <- nlcd.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(NLCD_Land,Acres,Percentage) %>% 
  dplyr::arrange(desc(Acres)) %>% 
  dplyr::rename("2016 NLCD Land Cover" = NLCD_Land,
                "Percent of Total Acres" = Percentage)

if(NROW(nlcd.waterbody)>0){
  
  nlcd.wb.tbl <- knitr::kable(nlcd.waterbody, format = "pandoc", padding = 2,
                              caption = tbls(name = paste0("nlcd.waterbody_",waterbody_name),
                                             caption = paste0("Summary of land uses within 100 meters of the digitized ", waterbody_name, " centerline based on the 2016 National Land Cover Database (Yang et al 2018).")))
  
}

nlcd.text.waterbody <- nlcd.text.pro.area %>% 
  dplyr::filter(Stream == waterbody_name)

# DMA
dma.waterbody <- dma.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(DMA_RP,Acres,Percentage) %>% 
  dplyr::arrange(desc(Acres)) %>% 
  dplyr::rename("DMA or Responsible Person" = DMA_RP,
                "Percent of Total Acres" = Percentage) 

if(NROW(dma.waterbody)>0){
  
  dma.wb.tbl <- knitr::kable(dma.waterbody, format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("dma.waterbody",waterbody_name),
                                            caption = paste0("Summary of designated management agencies (DMAs) or responsible persons within 100 meters of the digitized ", waterbody_name, " centerline.")))
  
}

```

The primary sources of thermal loading contributing to temperatures exceedances along the `r waterbody_name` include increases in solar radiation loading from the disturbance or removal of near-stream vegetation, `r if(npdes.ind.n>0){paste0("point source discharges, ")}`reductions to the stream flow rate or volume, **[Update as needed]** and background sources (`r strip_alpha(section.model.info$"Abbreviated Reference")`). Other potential sources include, channel modification and widening, reductions to stream flow rate, and warming caused by climate change. The contribution of these later sources will be investigated as part of the model scenarios. 

`r if(waterbody_name == "Columbia Slough"){paste0("The model includes 51 point source tributaries (storm water, combined sewer overflows and surface runoff), 12 distributed groundwater inflows, 12 irrigation withdrawals, 39 culverts, 4 weirs and 2 pump stations (Berger 2003).")}`

`r npdes.txt`

`r if(npdes.ind.n > 0){npdes.ind.tbl}`

The majority land use`r if(NROW(nlcd.text.waterbody)>0){s(nlcd.text.waterbody$n)}` along the `r waterbody_name` `r if(NROW(nlcd.text.waterbody)>0){is.are(nlcd.text.waterbody$n[1])}` `r if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$text}` accounting for about `r if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$MajorityPercent}` percent of the near stream area. `r tbls(name = paste0("nlcd.waterbody_",waterbody_name),display="cite")` summarizes all the land uses within 100 meters of the digitized `r waterbody_name` centerline. Land uses were summarized using the 2016 National Land Cover Database (Yang et al 2018). Note that Shrub/Scrub and Herbaceous land uses can be areas where forest clearcuts have occurred and would be classified as forest after regrowth.

`r if(NROW(nlcd.waterbody)>0){nlcd.wb.tbl}`

A designated management agency is defined in OAR 340-042-0030(2) as a federal, state, or local governmental agency that has legal authority over a sector or source contributing pollutants. Typically persons, including designated management agencies that are identified in the TMDL Water Quality Management Plan (WQMP) are responsible for developing TMDL implementation plans and implementing management strategies to reduce pollutant loading. `r tbls(name = paste0("dma.waterbody",waterbody_name),display="cite")` summarizes the potential designated management agencies and responsible persons along the `r waterbody_name` model extent. 

`r if(NROW(dma.waterbody)>0){dma.wb.tbl}`

### Time frame of simulation

The model period is `r format(as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30"), format="%B %d, %Y")` to `r format(as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30"), format="%B %d, %Y")`.

### Important assumptions

The effort currently described in the QAPP includes use of existing models. Key calibration assumptions made during the model setup and calibration process were documented in the original TMDL `r paste0("(", knitr::combine_words(strip_alpha(unique(sort(model.info[is.na(model.info$'Reference Report'),]$"Abbreviated Reference")))), ")")`, the model user guide `r knitr::combine_words(strip_alpha(unique(sort(unique(tmdl.mod.2$mod_ref_intext)))))` or in Section 6 and Section 7 of this document.

### Model inputs

```{r, label=`t6x6_1`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x6 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x6 <- c(chap6x6, knitr::knit_child(input = "chap6x6.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x6_met <- section.model.input %>% 
    dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
    dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
    dplyr::group_by(`Station ID`,`Model Location Type`, `Location Units`, `Data Source`,Note) %>% 
    dplyr::summarize(`Model Location` = toString(unique(sort(round(`Model Location`,2)))),
                     Parameter = toString(unique(sort(Parameter))))%>% 
    dplyr::ungroup() %>%
    dplyr::rename(`Model Location Name (Station ID)` = `Station ID`,
                  `Input Type` = `Model Location Type`)
  
  t6x6_1 <- section.model.input %>% 
    dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
    dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                              `Model Location Name`,
                                                              paste0(`Model Location Name`, " (", `Station ID`, ")")),
                  `Model Location` = round(`Model Location`,2),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
    dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
    dplyr::rename(`Input Type` = `Model Location Type`) %>% 
    rbind(t6x6_met) %>% 
    dplyr::arrange(`Input Type`,Parameter,desc(`Model Location`))
  
  t6x6_col <- t6x6_1 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x6_1)[names(t6x6_1) == "Model Location"] <- if(NROW(t6x6_col)>0){paste0("Model Location (",unique(t6x6_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x6_1 <- t6x6_1[,-c(3)] %>% 
    dplyr::rename(`Model Input` = Parameter)
  
  if(NROW(t6x6_1)>0){
    
    t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                               caption = paste0("Boundary condition and tributary inputs to the existing ", waterbody_name, " Heat Source Model.")))
    
  }
  
  t6x6_1.txt <- "For a description of model setup and inputs, see Berger and Wells 2005."
  
}

```

`r if(!model.extent == TRUE){} else {if(NROW(t6x6_1)>0){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the current configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized to improve documentation of the TMDL approach.")}else{t6x6_1.txt}}`

`r if(!model.extent == TRUE){paste(chap6x6, collapse = "\n")}else{if(NROW(t6x6_1)>0){t6x6_1_tbl}}`

```{r, label=`t6x6_2`, echo=FALSE}

t6x6_2 <- section.model.input %>%
  dplyr::filter(`Model Location Type` %in% "Meteorological")

```

`r if(NROW(t6x6_2)>1){paste0("Hourly meteorology inputs into the model include ", tolower(knitr::combine_words(unique(sort(t6x6_2$Parameter)))),". Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area.")}else{paste0("There are no meteorology inputs into the model.")}`

`r if(!is.na(unique(section.model.info$"Veg Notes"))){paste0("Near stream vegetation inputs to the model include vegetation height and canopy cover. ", unique(section.model.info$"Veg Notes"))}`

### Model calibration

```{r, label=`t6x7`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x7 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x7 <- c(chap6x7, knitr::knit_child(input = "chap6x7.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x7 <- section.model.input %>% 
    dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
    dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                  Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                  `Model Location` = round(`Model Location`,2),
                  `Model Location` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location`),
                  `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                  `Model Location Name` = ifelse(`Model Location Name` %in% c("Mouth to Headwaters","Headwaters to mouth"),"Model extent",`Model Location Name`),
                  `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                              `Model Location Name`,
                                                              paste0(`Model Location Name`, " (",`Station ID`,")")))%>% 
    dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`) %>% 
    dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
    dplyr::ungroup() %>% 
    dplyr::arrange(desc(as.numeric(`Model Location`))) %>% 
    dplyr::rename(`Calibration Parameter` = `Parameter`)
  
  t6x7_col <- t6x7 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x7)[names(t6x7) == "Model Location"] <- if(NROW(t6x7_col)>0){paste0("Model Location (",unique(t6x7_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x7 <- t6x7[,c(1,2,5,4)]
  
  if(NROW(t6x7)>0){
    
    t6x7_tbl <- knitr::kable(t6x7, format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("t6x7", waterbody_name),
                                            caption = paste0("Calibration sites and parameters used in the existing ", waterbody_name, " Heat Source Model.")))
    
  }
  
  mod.loc <- ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs7","hs8","hs9"),
                    print("The model location in the table below describes the distance of each input from the most downstream model node."),
                    ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs6"),
                           print("The model location in the table below describes the distance of each input from the most upstream model node."),
                           print("")))
  
  t6x7_1.txt <- "**[Update for CE-QUAL-W2 model]**"
  
}

```

`r if(waterbody_name == "Columbia Slough"){paste0("Model calibration was completed by PSU (Berger, 2003). Please refer to this report and Berger and Wells 2005 for more information.")}`

`r if(!model.extent == TRUE){} else {if(NROW(t6x7)>0){paste0("Model calibration was completed by ", knitr::combine_words(unique(sort(section.model.info$"Calibration Org")))," (", knitr::combine_words(strip_alpha(unique(sort(section.model.info$"Abbreviated Reference")))),"). The model calibration sites and data sources are summarized in ", tbls(name = paste0("t6x7", waterbody_name),display="cite"), " to improve documentation of the TMDL approach. ", mod.loc[1], " If it is determined that the model calibration needs to be updated, the model inputs and parameters that are expected to be modified to improve model fit are described in Section 6.2 General model inputs and parameters.")}}`

`r if(!model.extent == TRUE) {paste(chap6x7, collapse = "\n")} else {if(NROW(t6x7)>0){t6x7_tbl}}`
