---
output: 
  word_document:
    reference_docx: T:/Temperature_TMDL_Revisions/model_QAPPs/R/data/Report_Template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r, label=`setup-chap6`, include=FALSE}
knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)
options(kableExtra.auto_format = F)
options(knitr.kable.NA = '')

# for test: waterbody_name <- "North Umpqua River"

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

model.extent <- ifelse(NROW(section.model.input)>0,
                       ifelse(section.model.input$`Model Waterbody` == section.model.input$`Model Extent`, TRUE, FALSE),
                       TRUE)

model.extent <- na.omit(model.extent)

```

## `r waterbody_name`

### Model domain

```{r, label=`t6x1`, include=FALSE}

if(length(section.model.info$`Model Extent Text`)>1){
  
  model.domain <- unique(sort(section.model.info$`Model Extent Text`))
  
} else {
  
  model.domain <- section.model.info$`Model Extent Text`
  
} 
```

The extent of the model domain is the `r model.domain`

### Spatial and temporal resolution

The model input sampling rate (*dx*) is `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")`. Output is generated every `r unique(section.model.info$"Output dx")` `r unique(section.model.info$"Output dx Units")`. The model time step (*dt*) is `r unique(section.model.info$dT)` `r unique(section.model.info$"dT Units")`.

A *dx* of `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")` was chosen to capture the range of solar flux input caused by the varied vegetation conditions along the length of the stream. The high resolution *dx* will allow evaluation of multiple vegetation management scenarios for each designated management agency.

### Source characteristics

**[Update: Source characteristics]**

### Time frame of simulation

The model period is `r format(as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30"), format="%B %d, %Y")` to `r format(as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30"), format="%B %d, %Y")`.

### Important assumptions

`r if(waterbody_name %in% c("Bull Run River (2016)","Salmon River (2016)", "Sandy River (2016)")){paste0("Model development for the ",gsub("\\s*\\([^\\)]+\\)","", waterbody_name)," relies on deriving flow or temperature inputs from a few small tributaries (",tbls(name = paste0("t6x6_1", waterbody_name),display="cite"),"). DEQ plans to use the direct surrogate or linear regression approaches described in Section 6.3 to derive stream temperature and a combination of a flow mass balance, drainage area ratio, and the flow-probability-probability-flow approaches to estimate stream flow. It assumed that these approaches do a reasonably good job of estimating the tributary temperature or flow. DEQ will assess the goodness of fit for these approaches where measured flow or temperature flow data are available.")}else{paste0("The effort currently described in the QAPP includes use of existing models with no changes to the models since their previous calibration. Key calibration assumptions made during the model setup and calibration process were documented in the original TMDL (DEQ, 2005) and model user guide (Boyd and Kasper, 2003).")}`

`r if(waterbody_name %in% c("Bull Run River (2016)","Salmon River (2016)", "Sandy River (2016)")){paste0("DEQ will review the vegetation conditions at sites where effective shade measurements were made in August of 2001 (",tbls(name = "t56_sandy", display="cite"),") and compare those conditions to site conditions in 2016. If the conditions do not appear to have changed significantly DEQ will use the effective shade measured in 2001 as a rough guide for model calibration purpose with the assumption that the shade will likely be about the same or have increased since 2001 if site conditions look similar.")}`

`r if(waterbody_name %in% c("Bull Run River (2016)","Salmon River (2016)", "Sandy River (2016)")){paste0("Other key assumptions about model constants are described in the Heat Source model user guide (Boyd and Kasper, 2003) or in Section 6 and Section 7 of this document.")}`

### Model inputs

```{r, label=`t6x6_1`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x6 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x6 <- c(chap6x6, knitr::knit_child(input = "chap6x6.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x6_met <- section.model.input %>% 
    dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
    dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
    dplyr::group_by(`Station ID`,`Model Location Type`, `Location Units`, `Data Source`,Note) %>% 
    dplyr::summarize(`Model Location` = toString(unique(sort(round(`Model Location`,2)))),
                     Parameter = toString(unique(sort(Parameter))))%>% 
    dplyr::ungroup() %>%
    dplyr::rename(`Model Location Name (Station ID)` = `Station ID`,
                  `Input Type` = `Model Location Type`)
  
  t6x6_1 <- section.model.input %>% 
    dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
    dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                              `Model Location Name`,
                                                              paste0(`Model Location Name`, " (", `Station ID`, ")")),
                  `Model Location` = round(`Model Location`,2),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
    dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
    dplyr::rename(`Input Type` = `Model Location Type`) %>% 
    rbind(t6x6_met) %>% 
    dplyr::arrange(`Input Type`,Parameter,desc(`Model Location`))
  
  t6x6_col <- t6x6_1 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x6_1)[names(t6x6_1) == "Model Location"] <- if(NROW(t6x6_col)>0){paste0("Model Location (",unique(t6x6_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x6_1 <- t6x6_1[,-c(3)] %>% 
    dplyr::rename(`Model Input` = Parameter)
  
    if(waterbody_name %in% c("Bull Run River (2016)", "Salmon River (2016)", "Sandy River (2016)")){
      
      if(NROW(t6x6_1)>0){
      
      t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                                  caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                                 caption = paste0("Boundary condition and tributary inputs to the ", waterbody_name, " Heat Source Model.")))
      
      }
      
      t6x6_1.txt <- "**[Update for CE-QUAL-W2 model]**"
      
    } else {
      
      if(NROW(t6x6_1)>0){
      
      t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                                  caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                                 caption = paste0("Boundary condition and tributary inputs to the existing", waterbody_name, " Heat Source Model.")))
      
      }
      
      t6x6_1.txt <- "**[Update for CE-QUAL-W2 model]**"
      
    }
  
}
  
```

`r if(!model.extent == TRUE){} else {if(NROW(t6x6_1)>0){if(waterbody_name %in% c("Bull Run River (2016)","Salmon River (2016)", "Sandy River (2016)")){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the expected configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized.")}else{paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the current configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized to improve documentation of the TMDL approach.")}}else{t6x6_1.txt}}`

`r if(!model.extent == TRUE){paste(chap6x6, collapse = "\n")}else{if(NROW(t6x6_1)>0){t6x6_1_tbl}}`

```{r, label=`t6x6_2`, echo=FALSE}

t6x6_2 <- section.model.input %>%
  dplyr::filter(`Model Location Type` %in% "Meteorological")

if(NROW(t6x6_2)>1){
  
  cat(paste0("Hourly meteorology inputs into the model include ", tolower(knitr::combine_words(unique(sort(t6x6_2$Parameter)))),". Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area. "))
  
} else {
  
  cat("There are no meteorology inputs into the model.")
  
}
```

### Model calibration

```{r, label=`t6x7`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x7 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x7 <- c(chap6x7, knitr::knit_child(input = "chap6x7.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x7 <- section.model.input %>% 
    dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
    dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                  `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                  `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                  `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                  Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                  `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                  `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                              `Model Location Name`,
                                                              paste0(`Model Location Name`, " (",`Station ID`,")")),
                  `Model Location` = round(`Model Location`,2)) %>% 
    dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`) %>% 
    dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
    dplyr::ungroup() %>% 
    dplyr::arrange(desc(`Model Location`)) %>% 
    dplyr::rename(`Calibration Parameter` = `Parameter`)
  
  t6x7_col <- t6x7 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x7)[names(t6x7) == "Model Location"] <- if(NROW(t6x7_col)>0){paste0("Model Location (",unique(t6x7_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x7 <- t6x7[,c(1,2,5,4)]
  
  t6x7_tbl <- knitr::kable(t6x7, format = "pandoc", padding = 2,caption = tbls(name = paste0("t6x7", waterbody_name),caption = paste0("Calibration sites and parameters used in the existing ", waterbody_name, " Heat Source Model.")))
  
  mod.loc <- ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs7","hs8","hs9"),
                    print("The model location in the table below describes the distance of each input from the most downstream model node."),
                    ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs6"),
                           print("The model location in the table below describes the distance of each input from the most upstream model node."),
                           print("")))
  
}

```

`r if(!model.extent == TRUE){} else {if(waterbody_name %in% c("Bull Run River (2016)","Salmon River (2016)", "Sandy River (2016)")){paste0("The expected temperature, and flow calibration sites for the ",waterbody_name,"model are summarized in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),". The model location in the table describes the distance of each input from the most downstream model node. The model inputs and parameters that are expected to be modified to improve model fit are described in Section 6.2 General model inputs and parameters.")}else{paste0("Model calibration was completed by ", knitr::combine_words(unique(sort(section.model.info$"Calibration Org")))," (", knitr::combine_words(strip_alpha(unique(sort(section.model.info$"Abbreviated Reference")))),"). The model calibration sites and data sources are summarized in ", tbls(name = paste0("t6x7", waterbody_name),display="cite"), " to improve documentation of the TMDL approach. ", mod.loc[1], " If it is determined that the model calibration needs to be updated, the model inputs and parameters that are expected to be modified to improve model file are described in Section 6.2 General model inputs and parameters.")}}`

`r if(!model.extent == TRUE) {paste(chap6x7, collapse = "\n")} else {if(NROW(t6x7)>0){t6x7_tbl}}`
