---
output: 
  word_document:
    reference_docx: N:/Status_and_Trend_Reports/Report_Files/Report_Template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r, label=`setup-chap6`, include=FALSE}

knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)

options(kableExtra.auto_format = F)
options(knitr.kable.NA = '')

# for test: waterbody_name <- "South Fork Little Butte Creek"

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.tmdl <- section.model.info %>% 
  dplyr::filter(is.na(`Reference Report`))

model.extent <- ifelse(NROW(section.model.input)>0,
                       ifelse(section.model.input$`Model Waterbody` == section.model.input$`Model Extent`, TRUE, FALSE),
                       TRUE)

model.extent <- na.omit(model.extent)

```

## `r waterbody_name`


### Source Characteristics

Temperature is the water quality parameter of concern, but heat, in particular heat from human activities or anthropogenic sources, is the pollutant of concern. Specifically, water temperature change is an expression of heat flux to waterbody (`r eqns(name = "temp_change", display="cite")`).   

$\Delta Temperature = \frac{\Delta Heat}{Density\times \text {Specific Heat}\times \Delta \text {Flow Volume}} \text { }$ (`r eqns(name = "temp_change", display="cite")`)

Stream temperature is influenced by natural factors such as climate, geomorphology, hydrology, and vegetation. Human or anthropogenic heat sources may include discharges of heated water to surface waters, increases solar radiation heat flux on the waterâ€™s surface due to the removal of near-stream vegetation and reductions in stream shading, changes to stream channel form, reductions in natural stream flows, and the reduction of coldwater inputs from groundwater.

### Model Domain

```{r, label=`t6x1`, include=FALSE}

if(length(section.model.info$`Model Extent Text`)>1){
  model.domain <- unique(sort(section.model.info$`Model Extent`))
} else {model.domain <- section.model.info$`Model Extent Text`} 

```

The extents of the model domain are/will be the `r model.domain`.

### Spatial and Temporal Resolution

The model input sampling rate (*dx*) is `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")`. Output is generated every `r unique(section.model.info$"Output dx")` `r unique(section.model.info$"Output dx Units")`. The model time step (*dt*) is `r unique(section.model.info$dT)` `r unique(section.model.info$"dT Units")`.

A *dx* of `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")` was chosen to capture the range of solar flux input caused by the varied vegetation conditions along the length of the stream. The high resolution *dx* will also allow evaluation of vegetation multiple vegetation management scenarios for each designated management agency.

### Time Frame of Simulation

The model period is `r format(as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30"), format="%B %d, %Y")` to `r format(as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30"), format="%B %d, %Y")`.

### Model Calibration

```{r, label=`t6x5`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x5 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x5 <- c(chap6x5, knitr::knit_child(input = "chap6x5.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x5 <- section.model.input %>% 
    dplyr::filter(`Model Location Type` == "Calibration Site") %>%
    dplyr::mutate(Location = ifelse(`Station ID` == "No Station ID or unknown" | is.na(`Station ID`),
                                    `Model Location Name`,
                                    paste0(`Model Location Name`, " (", `Station ID`, ")"))) %>%   
    dplyr::mutate(`Model_Location` = ifelse(is.na(`Model Location`), NA, paste0(`Model Location`," ", `Location Units`))) %>%
    dplyr::mutate(`Data Source` = ifelse(`Station ID` == "TIR", strip_alpha(`Data Source`), `Data Source`)) %>% 
    dplyr::arrange(Parameter,desc(`Model Location`)) %>% 
    dplyr::select(Location, `Model_Location`, `Parameter`, `Data Source`) %>% 
    dplyr::rename(`Model Location` = `Model_Location`,
                  `Calibration Parameter` = `Parameter`)
  
  t6x5_tbl <- knitr::kable(t6x5, format = "pandoc", padding = 2,caption = tbls(name = paste0("t6x5", waterbody_name),caption = paste0("Calibration sites and parameters used in the existing ", waterbody_name, " Heat Source Model.")))
  
}

```

Model calibration was completed by DEQ and described in the `r paste0(unique(section.tmdl$"TMDL Document"), " (", strip_alpha(unique(section.tmdl$"Abbreviated Reference")), ")")`. It is not anticipated that adjustments to the calibrated model will be made as part of this QAPP. Temperature, flow, and effective shade calibration sites are summarized here to improve documentation of the TMDL approach. If adjustments are made to the calibration model in the future, the QAPP will be amended to reflect the additional effort.

`r if(!model.extent == TRUE) {paste(chap6x5, collapse = "\n")} else {if(NROW(t6x5)>0){t6x5_tbl}}`

### Model Parameters

```{r, label=`t6x6_1`, include=FALSE}

# HS
hsv.num <- unique(substr(section.tmdl$"Model version", 13,13))
hsv.tbl <- readxl::read_xlsx(paste0(data.dir, "hs_tbl.xlsx"), sheet = paste0("hs", hsv.num))

hsv_tbl <- knitr::kable(hsv.tbl, format = "pandoc", padding = 2,
                        caption = tbls(name = paste0("hsv.tbl", waterbody_name), 
                                       caption = paste0("Summary of model inputs and input categories required for Heat Source version ", hsv.num,".")))

# Model parameter input
if(!model.extent == TRUE){
  
  chap6x6 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x6 <- c(chap6x6, knitr::knit_child(input = "chap6x6.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  t6x6_met <- section.model.input %>% 
    dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>% 
    dplyr::group_by(`Station ID`,`Model Location Type`, `Location Units`, `Data Source`) %>% 
    dplyr::summarize(`Model Location` = toString(unique(sort(`Model Location`))),
                     Parameter = toString(unique(sort(Parameter))))%>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(`Model_Location` = paste0(`Model Location`," ", `Location Units`)) %>% 
    dplyr::select(`Station ID`, `Model_Location`, `Model Location Type`, Parameter, `Data Source`) %>% 
    dplyr::rename(`Location/Station ID` = `Station ID`,
                  `Model Location` = Model_Location,
                  `Input Type` = `Model Location Type`,
                  `Data Source/Notes` = `Data Source`)
  
  t6x6_1 <- section.model.input %>% 
    dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
    dplyr::mutate(`Location/Station ID` = ifelse(`Station ID` == "No Station ID or unknown" | is.na(`Station ID`),
                                                 `Model Location Name`,
                                                 paste0(`Model Location Name`, " (", `Station ID`, ")"))) %>%  
    dplyr::mutate(`Model_Location` = ifelse(is.na(`Model Location`), NA, paste0(round(`Model Location`,2)," ", `Location Units`))) %>%
    dplyr::mutate(DataSource = ifelse(`Interpolated Data` == "T",
                                      ifelse(!is.na(`Data Source`),
                                             paste0(`Data Source`, ". ", Note), 
                                             Note),
                                      ifelse(!is.na(`Data Source`), 
                                             `Data Source`, 
                                             NA))) %>% 
    dplyr::select(`Location/Station ID`, `Model_Location`, `Model Location Type`, `Parameter`, DataSource) %>%
    dplyr::rename(`Model Location` = `Model_Location`,
                  `Input Type` = `Model Location Type`,
                  `Data Source/Notes` = DataSource) %>% 
    rbind(t6x6_met) %>% 
    dplyr::arrange(Parameter,desc(`Model Location`))
  
  t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                              caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                             caption = paste0("Boundary condition and tributary inputs to the existing ", waterbody_name, " Heat Source Model.")))
  
}

```

```{r, child=paste0("hs",hsv.num,".Rmd")}
```

`r hsv_tbl`

`r if(!model.extent == TRUE){} else {paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the model input parameters, the source of that data, and those parameters which will be most likely adjusted to improve calibration and fit. Temperature, flow, and meteorological input parameters are summarized to improve documentation of the TMDL approach. If adjustments are made to the calibration model in the future, the QAPP will be amended to reflect the additional effort.")}`

`r if(!model.extent == TRUE){paste(chap6x6, collapse = "\n")}else{if(NROW(t6x6_1)>0){t6x6_1_tbl}}`

```{r, label=`t6x6_2`, echo=FALSE}

t6x6_2 <- section.model.input %>%
  dplyr::filter(`Model Location Type` == "Meteorological")

if(NROW(t6x6_2)>1){
  
  cat(paste0("Hourly meteorology inputs into the model include ", tolower(knitr::combine_words(unique(sort(t6x6_2$Parameter)))),". The data source for these inputs is the ", unique(sort(t6x6_2$`Station ID`)), " ", unique(sort(t6x6_2$`Data Source`)), ". Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area. "))
  
  cat(unique(sort(t6x6_2$Note)))

} else {
  
  cat("There is no meteorology inputs into the model.")
  
}

```

### Data Gaps

Data gaps include:

* Tributary flow and temperature measurements for all tributary model inputs.  
* Measurements of withdrawals flow (if any) within the model extent.  
* The data source and quality for the following boundary condition inputs: `r if(NROW(t6x6_1)>0){paste(unique(sort(t6x6_1$"Location/Station ID"), collapse = ", "))}else{cat("No data")}`. **[UPDATE FOR EACH STREAM]**

Data gaps were identified and addressed during original development of the `r waterbody_name` model. These approaches have not changed as the calibrated models are being used without refinements. If updates are made to the models in the future, this information will be updated and documented in an addendum to this QAPP. The modeling framework utilizes the best available data for setting up the model boundary conditions to provide a sound technical basis for TMDL analysis and evaluation of the temperature water quality standards.

### Important Assumptions

Key assumptions made during collection, handling, transformation (harmonizing format and terms for compilation), and incorporation of data into the existing model was documented in the QAPP for the original modeling. The effort currently described in the QAPP includes use of existing models with no changes to the models since their previous calibration. 