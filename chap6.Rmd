---
output: 
  word_document:
    reference_docx: T:/Temperature_TMDL_Revisions/model_QAPPs/R/data/rmd_template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r, label=`setup-chap6`, include=FALSE}
knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)
options(kableExtra.auto_format = F)
options(knitr.kable.NA = '')

# for test: waterbody_name <- "Clackamas River"

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

model.extent <- ifelse(NROW(section.model.input)>0,
                       ifelse(section.model.input$`Model Waterbody` == section.model.input$`Model Extent`, TRUE, FALSE),
                       TRUE)

model.extent <- na.omit(model.extent)

```

## `r waterbody_name`

`r paste0("The ",waterbody_name," model is a ",tolower(ifelse(unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Primary Model Parameter") == "Solar", "shade",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Primary Model Parameter")))," model developed using ",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Model version"),". The model ",if(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"New Model" %in% "T"){paste0("will be")}else{paste0("was")}," developed by ",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Calibration Org"),".")`

### Model domain

```{r, label=`t6x1`, include=FALSE}

model.domain <- unique(sort(section.model.info$`Model Extent Text`))

```

The extent of the model domain is `r model.domain` The model extent is shown in the HTML interactive map that accompanies this QAPP and is referenced in Appendix E.

### Spatial and temporal resolution

`r if(waterbody_name == "Clackamas River"){paste0("The existing 2001/2002 model input bathymetry uses one water body and two branches. The branches were selected based on changes in the channel bottom slope. The model grid has 149 segments; 145 of which are active (Branch 1 Segments 2 to 94 and Branch 2 Segments 97 to 148); and each segment has a length of 251.06 meters. The upstream boundary is configured using the flow and temperature from the USGS gage station at Estacada. The downstream boundary condition is configured as an artificial spillway which discharges to the Lower Willamette River.")}`

`r if(waterbody_name == "Long Tom River"){paste0("The existing current conditions model input bathymetry uses one water body and 13 branches along the main river and one branch representing a side channel. The branches were incorporated into the model to accurately predict the flow peak timings due to the several weirs/dams that lie along the model domain. The model grid has 187 segments, with each segment lengths ranging from 83.88 meters to 251.06 meters. The side channel is comprised of 3 segments of 1897, 2590, and 1427 meters. The upstream boundary is configured using the flow and temperature from the USGS gage station near Alvadore (USGS 1416999) at RM 23.5. There are ten spillway structures defined along the systems, and three gates.  The downstream boundary condition is configured as an artificial gate which discharges to the Willamette River. The model also includes one withdrawal from segment 91 (RM 12.9) of 4 cfs.  It should be noted that the PSU documentation (Annear et. al, 2004) notes that there were no withdrawals, however the 2001 and 2002 model do have this withdrawal. In addition, the PSU model documentation also does not discuss the gates in the model.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("The model is comprised of two waterbodies, with a total of 13 branches. The first water body consists of two branches; the first is the main stem of the Willamette River and the second is Multnomah Channel. The Columbia River represents the second water body with 11 branches. The first branch in water body two is the main channel of the Columbia River and the remaining 10 branches are tributary inflow reaches or side channels around islands. Segment size was based on the spacing of the bathymetry data cross sections (PSU report Annear, et. al 2004). The model’s vertical grid resolution is 2 meters throughout, with a maximum of 28 layers.")}`

`r if(waterbody_name %in% c("Coast Fork and Middle Fork Willamette River","McKenzie River: Lower","North Santiam and Santiam River","South Santiam River","Willamette River: Middle","Willamette River: Upper")){paste0("[Update:] The model setup and calibration process are documented in the USGS report (citation).")}`

### Source characteristics

```{r, label=`sc`, include=FALSE}

# NPDES
npdes.ind.waterbody <- npdes.ind.pro.area %>%
  dplyr::filter(grepl(pattern=gsub("\\s*\\([^\\)]+\\)","",x=waterbody_name), x=`Stream Name`, ignore.case = TRUE)) %>% 
  dplyr::mutate(`Facility Name (Facility Number)` = paste0(`Common Name`," (", `WQ File Nbr`,")"),
                `Latitude/Longitude` = paste0(round(Latitude,4), "/",round(Longitude,3)),
                `Permit Type and Description` = paste0(`Permit Type`, ": ", `Permit Description`),
                `River Mile` = round(`River Mile`,1),
                `Stream/River Mile` = ifelse(is.na(`Stream Name`), NA, paste0(`Stream Name`, " ", " RM ",`River Mile`))) %>% 
  dplyr::select(`Facility Name (Facility Number)`, `Latitude/Longitude`,`Permit Type and Description`, `Stream/River Mile`) %>% 
  dplyr::arrange(`Facility Name (Facility Number)`)

npdes.ind.n <- nrow(npdes.ind.waterbody)

if(npdes.ind.n>0){
  
  npdes.ind.tbl <- knitr::kable(npdes.ind.waterbody, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),
                                               caption = paste0("Summary of individual NPDES permitted discharges in the ", waterbody_name, ".")))
  
}

if(npdes.ind.n == 0) {
  npdes.txt <- "There are no permitted individual NPDES point sources along the model extent."
} 

if(npdes.ind.n == 1) {
  npdes.txt <- paste0("There is one permitted individual NPDES point source along the model extent. Detail about the point source is summarized in ",tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite"), ".")
}

if(npdes.ind.n > 1) {
  npdes.txt <- paste0("There are ", numbers.to.words(npdes.ind.n)," permitted individual NPDES point sources along the model extent. Detail about each point source is summarized in ",tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite"),".")
} 

# NLCD
nlcd.waterbody <- nlcd.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(NLCD_Land,Acres,Percentage) %>% 
  dplyr::rename("2016 NLCD Land Cover" = NLCD_Land,
                "Percent of Total Acres" = Percentage)

if(NROW(nlcd.waterbody)>0){
  
  nlcd.wb.tbl <- knitr::kable(nlcd.waterbody, format = "pandoc", padding = 2,
                              caption = tbls(name = paste0("nlcd.waterbody_",waterbody_name),
                                             caption = paste0("Summary of land uses within 300 meters of the digitized ", waterbody_name, " centerline based on the 2016 National Land Cover Database (Yang et al 2018).")))
  
}

nlcd.text.waterbody <- nlcd.text.pro.area %>% 
  dplyr::filter(Stream == waterbody_name)

# DMA
dma.waterbody <- dma.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(DMA_RP,Acres,Percentage) %>% 
  dplyr::rename("DMA or Responsible Person" = DMA_RP,
                "Percent of Total Acres" = Percentage) 

if(NROW(dma.waterbody)>0){
  
  dma.wb.tbl <- knitr::kable(dma.waterbody, format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("dma.waterbody",waterbody_name),
                                            caption = paste0("Summary of potential designated management agencies (DMAs) or responsible persons within 300 meters of the digitized ", waterbody_name, " centerline.")))
  
}

```

The primary sources of thermal loading contributing to temperatures exceedances along the `r waterbody_name` include increases in solar radiation loading from the disturbance or removal of near-stream vegetation, `r if(npdes.ind.n>0){paste0("point source discharges, ")}`reductions to the stream flow rate or volume, **[Update as needed]** and background sources (`r strip_alpha(section.model.info$"Abbreviated Reference")`). Other potential sources include channel modification and widening, reductions to stream flow rate, and warming caused by climate change. The contribution of these latter potential sources may be investigated as part of the model scenarios. 

`r npdes.txt`

`r if(npdes.ind.n > 0){npdes.ind.tbl}`

The majority land use`r if(NROW(nlcd.text.waterbody)>0){s(nlcd.text.waterbody$n)}` along the `r waterbody_name` `r if(NROW(nlcd.text.waterbody)>0){is.are(nlcd.text.waterbody$n[1])}` `r if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$text}` accounting for about `r if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$MajorityPercent}` percent of the near stream area. `r if(NROW(nlcd.waterbody)>0){tbls(name = paste0("nlcd.waterbody_",waterbody_name),display="cite")}` summarizes all the land uses within 300 meters of the digitized `r waterbody_name` centerline. Land uses were summarized using the 2016 National Land Cover Database (Yang et al 2018). Note that Shrub/Scrub and Herbaceous land uses can be areas where forest clearcuts have occurred and would be classified as forest after regrowth.

`r if(NROW(nlcd.waterbody)>0){nlcd.wb.tbl}`

Anthropogenic related stream warming caused by nonpoint sources is closely associated with the uses, the activities, and the condition of vegetation adjacent to the stream. How activities and uses are managed in these areas is partially determined by a variety of different rules and management plans established by the landowner and any agency with land use authority. To better understand the spatial distribution of different agency rules or management plans along the model extent DEQ mapped known designated management agencies.

A designated management agency is defined in OAR 340-042-0030(2) as a federal, state, or local governmental agency that has legal authority over a sector or source contributing pollutants. Typically, persons or designated management agencies that are identified in the TMDL Water Quality Management Plan (WQMP) are responsible for developing TMDL implementation plans and implementing management strategies to reduce pollutant loading. `r if(NROW(dma.waterbody)>0){tbls(name = paste0("dma.waterbody",waterbody_name),display="cite")}` summarizes the potential designated management agencies and responsible persons along the `r waterbody_name` model extent. 

`r if(NROW(dma.waterbody)>0){dma.wb.tbl}`

### Time frame of simulation

```{r, label=`tf`, include=FALSE}

model_period_start <- as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30")
model_period_end <- as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30")

```

`r if(waterbody_name %in% c("Clackamas River","Long Tom River","Willamette River: Lower")){paste0("Data availability during the year 2015 and 2016 were evaluated. The proposed model simulation period is the year 2015. The modeling period will cover the months from April to November to be consistent with the existing USGS v4.2 models.")}`

`r if(waterbody_name %in% c("Coast Fork and Middle Fork Willamette River","McKenzie River: Lower","North Santiam and Santiam River","South Santiam River","Willamette River: Middle","Willamette River: Upper")){if(as.integer(as.numeric(as.Date(model_period_start))) == as.integer(as.numeric(as.Date(model_period_end)))){paste0("The model period is for a single day: ",format(model_period_start, format="%B %d, %Y"),".")}else{paste0("The model period is ", format(model_period_start, format="%B %d, %Y"), " to ", format(model_period_end, format="%B %d, %Y"), ".")}}`

### Important assumptions

**[Update this section if any changes are proposed to the current condition calibration model]**. The effort currently described in the QAPP includes use of existing models. Key calibration assumptions made during the model setup and calibration process were documented in the original TMDL `r paste0("(", knitr::combine_words(strip_alpha(unique(sort(model.info[is.na(model.info$'Reference Report'),]$"Abbreviated Reference"))),sep = "; "), ")")`, the model user guide `r knitr::combine_words(strip_alpha(unique(sort(unique(tmdl.mod.2$mod_ref_intext)))))` or in Section 6 and Section 7 of this document.

### Model inputs

```{r, label=`t6x6_1`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table
if(!model.extent == TRUE){
  
  chap6x6 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x6 <- c(chap6x6, knitr::knit_child(input = "chap6x6.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  if(!qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x6_met <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
      dplyr::group_by(`Station ID`,`Model Location Type`, `Location Units`, `Data Source`,Note) %>% 
      dplyr::summarize(`Model Location` = toString(unique(sort(round(`Model Location`,2)))),
                       Parameter = toString(unique(sort(Parameter))))%>% 
      dplyr::ungroup() %>%
      dplyr::rename(`Model Location Name (Station ID)` = `Station ID`,
                    `Input Type` = `Model Location Type`)
    
    t6x6_1 <- section.model.input %>% 
      dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")")),
                    `Model Location` = round(`Model Location`,2),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
      dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
      dplyr::rename(`Input Type` = `Model Location Type`) %>% 
      dplyr::arrange(`Input Type`,Parameter,desc(as.numeric(`Model Location`))) %>% 
      rbind(t6x6_met)
   
  }
  
  if(qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x6_met <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")"))) %>% # Willamette MS
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`, `Location Units`, `Model Location Type`, `Data Source`,Note) %>%    # Willamette MS
      dplyr::summarize(#`Model Location` = toString(unique(sort(round(`Model Location`,2)))),                                # Willamette MS
        Parameter = toString(unique(sort(Parameter))))%>% 
      dplyr::ungroup() %>%
      dplyr::rename(# `Model Location Name (Station ID)` = `Station ID`,                                                     # Willamette MS
        `Input Type` = `Model Location Type`)
    
    t6x6_1 <- section.model.input %>% 
      dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")")),
                    #`Model Location` = round(`Model Location`,2),                                                           # Willamette MS
                    `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
      dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
      dplyr::rename(`Input Type` = `Model Location Type`) %>% 
      dplyr::arrange(`Input Type`,Parameter,desc(`Model Location`)) %>% 
      rbind(t6x6_met)
   
  }
  
  t6x6_col <- t6x6_1 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x6_1)[names(t6x6_1) == "Model Location"] <- if(NROW(t6x6_col)>0){paste0("Model River Mile /Segment Number")}else{paste0("Model Location")}
  
  t6x6_1 <- t6x6_1[,-c(3)] %>% 
    dplyr::rename(`Model Input` = Parameter)
  
  if(NROW(t6x6_1)>0){
    
    t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                               caption = paste0("Boundary condition and tributary inputs to the ", 
                                                                ifelse(is.na(section.model.info$`New Model`),"existing ",""), 
                                                                waterbody_name, 
                                                                " Heat Source Model.")))
    
  }
  
  t6x6_1.txt <- "**[Update for CE-QUAL-W2 model]**"
  
}
```

`r if(waterbody_name == "Clackamas River"){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the model configuration of the model input parameters and the source of these data. Meteorological, flow, and temperature input parameters are summarized in the table along with relevant data gaps.")}`

`r if(waterbody_name == "Clackamas River"){paste0("For Meteorological input development, previously PGE data from River Mill Dam was used for Air Temperature in conjunction with Eagle Creek to fill in gaps. Air Temperature data from River Mill Dam is not currently available. Air temperature data from Eagle Creek in conjunction with Aurora State Airport will potentially be used.")}`

`r if(waterbody_name == "Clackamas River"){paste0("Daily flow values were developed for Deep, Clear, and Eagle Creeks by Kent Doughty with EES, a consultant in the modeling effort for the Lower Clackamas River for Portland General Electric. Further flow relationships were also developed with the USGS gage at Estacada to fill in gags during the development of the current conditions calibration model. It is anticipated that these flow correlations will be used to develop tributary flow boundaries for the 4 tributaries – Eagle Creek, Deep Creek, Clear Creek, and Rock Creek in the 2015 model.")}`

`r if(waterbody_name == "Clackamas River"){paste0("There is one point source, the Clackamas River Fish Hatchery, for which flow and water temperature data will be updated using DMR data provided by DEQ. This point source input is not discussed in the PSU model documentation (Annear et. al, 2004) but this input is included in the model received by Tt from DEQ. Further the model includes withdrawals at five specific locations which are not discussed in the PSU documentation (Annear et. al, 2004). Withdrawal information will be required for 2015 for model development.")}`

`r if(waterbody_name == "Clackamas River"){paste0("The distributed flows were estimated. The daily tributary flows and the daily upstream flow at Estacada were summed and then subtracted from the flow measured at Oregon City to estimate any additional inflow to the river attributable to the ungaged drainage areas. The total distributed flow was then divided in two based on the lengths of the two model branches. The five withdrawals identified in the model would also need to be included in the flow balance.")}`

`r if(waterbody_name == "Clackamas River"){paste0("Water temperature data for each of the four tributaries was previously available from PGE during 2001/2002 is not available for 2015/2016. This is an important data gap (along with the Fish Hatchery data) that needs be filled. Water Temperature at Eagle Creek and Deep Creek can potentially be estimated using regression relationships developed between the Estacada USGS site. No water temperature data is available for Clear Creek. For Rock Creek previously, data from Deep Creek were directly used for this tributary and can be used. No groundwater monitoring water temperature data is available for 2015 or 2016, similar to what was collected by PGE during 2000 and 2001 which was used to configure the distributed tributary temperatures.")}`

`r if(waterbody_name == "Long Tom River"){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the current configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized in the table along with relevant data gaps.")}`

`r if(waterbody_name == "Long Tom River"){paste0("Meteorology data were taken from the Corvallis Airport during 2001 and from the Eugene Airport during 2002. The appropriate meteorology data will be chosen from either Eugene Airport or Corvallis Airport. Note that additional air temperature stations from MesoWest and from NCDC may be available and if necessary will be used to supplement the air temperatures in the meteorological input file.")}`

`r if(waterbody_name == "Long Tom River"){paste0("No tributary inflows were modeled in the existing model setup, rather they are included as distributed tributaries. Flow rates for the distributed tributaries were determined by balancing flows using gaging station data. The only diversion in the model setup is for the Ferguson Dam Diversion set as a constant value of 0.113 cms for 2001 (same was used for 2002). If no data is available for 2015 then the same constant value will be used for flow balance estimation.")}`

`r if(waterbody_name == "Long Tom River"){paste0("Gate flows for Old Long Tom varied slightly for 2001 and 2002, based on the existing input file. Information on this if available can be used to configure 2015. In addition Gate weir elevation for Ferguson Dam and downstream boundary condition were in the 2001/2002 model. Unless new data is available for 2015, the same data will be used for 2015.")}`

`r if(waterbody_name == "Long Tom River"){paste0("There are no point sources represented in the existing model. The City of Monroe STP, which is a new point source input, will be included in the model. DMR data will be queried for this facility and processed for specifying in the model (",tbls(name = paste0("t6x6_1", waterbody_name),display="cite"),").")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the current configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized in the table along with relevant data gaps.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("The upstream boundary condition for the Lower Willamette River near the Willamette Falls was characterized by the outflow from the Middle Willamette River model. The PSU report (Annear et. al, 2004) notes that “although there are USGS gages station monitoring stage above (USGS 14207740) and below (USGS 14207770) the Willamette Falls, the gage above the falls is not always accurate”.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Some of the missing boundary inputs include water temperature data for the Columbia near Beaver Terminal, water temperature for the Columbia Slough, and water temperature for several tributaries that were previously monitored by Washington Ecology.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Water Temperature at Columbia River at Port Westward, near Quincy, OR (14246900) (previously called Beaver Terminal) ends at 9/30/2003. This station was previously used to configure one of the downstream boundaries for the Columbia River. Potentially stations upstream (Astoria, OR) and downstream (Longview, WA) of this location can be considered for use to configure the model for the year 2015. The NOAA station Astoria, OR ([Station ID: 9439040][9439040]) is located approximately 35 miles upstream of Beaver Terminal and has hourly data from 11/4/1993 to current. The Longview, WA station ([Station ID: 9440422][9440422]) is located approximately 12 miles downstream of Beaver Terminal and has hourly data for the period from 6/3/2005 to 7/24/2014 and from 10/16/2015 to current. Note that the Longview station alone cannot be used since it has a gap during 2015, which would need to be filled (potentially using the Astoria station). Or alternatively, if appropriate the Astoria station alone can be used to configure the model boundary.  All water temperature data would first need to be plotted and analyzed for correlations before using it for configuring the model.")}`

[9439040]: https://tidesandcurrents.noaa.gov/stationhome.html?id=9439040
[9440422]: https://tidesandcurrents.noaa.gov/stationhome.html?id=9440422

`r if(waterbody_name == "Willamette River: Lower"){paste0("The water temperature data for the Columbia Slough during 2001/2002 was characterized using two monitoring instruments at same location LASAR 11201 and Metro Regional Govt (SJB). Data collected by the City of Portland from North Vancouver St. Bridge (Main Channel – Columbia Slough) VNB will be used to configure the water temperature for the Columbia Slough. Data for the year 2015 is only available for a few months and is not available from May through Oct during 2015. Data is available for other years (2016) at this station. Available data from other years will be use to develop correlations for filling gaps or will be filled by directly supplementing the data from other years for the missing periods.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Additionally monthly water temperature for several tributaries that were previously monitored by the Washington Ecology in the Monthly Baseflow Characteristics of Selected Washington Rivers and Streams report (Water Supply Bulletin No. 60, Publication No. 99-327, October 1999) would be used for 2015, if no data is available.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("The PSU report states that flow contributions from the smaller basins were not determined individually and were incorporated as distributed tributaries (i.e. distributed input in the W2 model). However, in a separate distributed tributaries section in the report it is noted that “the total drainage area not considered in the model was about 0.34% of the entire watershed drainage and hence not considered in the model as it was relatively small”. This was confirmed by looking at the current W2 model in which the distributed tributaries were turned off.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Point Source data are needed for configuring the model for 2015. DMR data will be queried and processed for specifying in the model. In addition to existing point sources currently in the model, there are nine new point sources that have been identified for inclusion into the model. All existing and new point sources have been identified in the ",tbls(name = paste0("t6x6_1", waterbody_name),display="cite"),".")}`

`r if(waterbody_name %in% c("Clackamas River","Long Tom River","Willamette River: Lower")){if(!model.extent == TRUE){paste(chap6x6, collapse = "\n")}else{if(NROW(t6x6_1)>0){t6x6_1_tbl}}}`

`r if(waterbody_name %in% c("Coast Fork and Middle Fork Willamette River","McKenzie River: Lower","North Santiam and Santiam River","South Santiam River","Willamette River: Middle","Willamette River: Upper")){paste0("[Update:] The model inputs are documented in the USGS report (citation).")}`

```{r, label=`t6x6_2`, echo=FALSE}

t6x6_2 <- section.model.input %>%
  dplyr::filter(`Model Location Type` %in% "Meteorological")

```

`r if(NROW(t6x6_2)>1){paste0("Hourly meteorology inputs into the model include ", tolower(knitr::combine_words(unique(sort(t6x6_2$Parameter)))),". Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area.")}else{paste0("There are no meteorology inputs into the model.")}`

`r if(!is.na(unique(section.model.info$"Veg Notes"))){paste0("The near stream vegetation inputs to the model include vegetation height and canopy cover. ", unique(section.model.info$"Veg Notes"))}`

### Model calibration

```{r, label=`t6x7`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table
if(!model.extent == TRUE){
  
  chap6x7 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x7 <- c(chap6x7, knitr::knit_child(input = "chap6x7.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  if(!qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x7 <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
      dplyr::filter(!Parameter %in% "Effective Shade") %>% 
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                    Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                    `Model Location` = round(`Model Location`,2),
                    `Model Location` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location`),
                    `Model Location Name` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location Name`),
                    `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                    `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (",`Station ID`,")")))%>% 
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`) %>% 
      dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
      dplyr::ungroup() %>% 
      dplyr::arrange(Parameter,desc(as.numeric(`Model Location`))) %>% 
      dplyr::rename(`Calibration Parameter` = `Parameter`)
    
  }
  
  if(qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x7 <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
      dplyr::filter(!Parameter %in% "Effective Shade") %>% 
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                    Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                    #`Model Location` = round(`Model Location`,2),
                    `Model Location` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location`),
                    `Model Location Name` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location Name`),
                    `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                    `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (",`Station ID`,")")))%>% 
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`,Note) %>% 
      dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
      dplyr::ungroup() %>% 
      #dplyr::arrange(`Model Location Name (Station ID)`) %>% # W. MS
      dplyr::rename(`Calibration Parameter` = `Parameter`)
    
  }
  
  t6x7_col <- t6x7 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x7)[names(t6x7) == "Model Location"] <- if(NROW(t6x7_col)>0){paste0("Model River Mile /Segment Number")}else{paste0("Model Location")}
  
  # Modified for W. MS:
  t6x7 <- t6x7[,c(1,2,6,4,5)] #
  
  if(NROW(t6x7)>0){
    
    if(waterbody_name %in% c("Clackamas River")){
      
          t6x7_tbl <- knitr::kable(t6x7[,-c(5)], format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("t6x7", waterbody_name),
                                            caption = paste0("Calibration sites and parameters used in the ", 
                                                             ifelse(is.na(section.model.info$`New Model`),"existing ",""), 
                                                             waterbody_name, 
                                                             " Heat Source Model.")))

    }
    
    if(waterbody_name %in% c("Long Tom River","Willamette River: Lower")){
      
          t6x7_tbl <- knitr::kable(t6x7, format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("t6x7", waterbody_name),
                                            caption = paste0("Calibration sites and parameters used in the ", waterbody_name, " Heat Source Model.")))
          
    }
    
  }
  
  mod.loc <- ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs7","hs8","hs9"),
                    print("The model location in the table below describes the distance of each input from the most downstream model node."),
                    ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs6"),
                           print("The model location in the table below describes the distance of each input from the most upstream model node."),
                           print("")))
  
  t6x7_1.txt <- "**[Update for CE-QUAL-W2 model]**"
  
}
```

`r if(waterbody_name == "Clackamas River"){paste0("Model calibration will focus on flow, water level, and water temperature data from calibration sites that have available data during the simulation period. Water Temperature data were available at the two USGS sites located at the upstream and downstream model extents, however data at four locations where river water temperature data were previously available from PGE, in the current conditions model during 2001/2002, are not available for 2015 or 2016 (",tbls(name = paste0("t6x7", waterbody_name),display="cite"),").  Wetted Channel widths were available during April and August of 2002 as part of field surveys done by the USGS. Wetted channel width data are not available for 2015 and/or 2016 for calibration purposes.")}`

`r if(waterbody_name == "Clackamas River"){paste0("The current condition calibration parameters (i.e. from 2001/2002) may need to be updated in the 2015 model to reflect spawning period conditions. Potential calibration adjustments may be made to Manning’s n coefficient, wind sheltering, evaporation, and sediment temperatures. Vegetative and topographic shade characteristics will not be adjusted since the model input was developed using a detailed GIS analysis. The model calibration location and available data during the years 2015 (and 2016) are shown below in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),".")}`

`r if(waterbody_name == "Long Tom River"){paste0("Model calibration will focus on flow, water level, and water temperature data from calibration sites that have available data during the simulation period.")}`

`r if(waterbody_name == "Long Tom River"){paste0("Out of the five water temperature calibration station locations only two stations have data i.e. the USGS stations at Alvadore and Monroe. The USGS station at Monroe only reports daily min/max/mean water temperatures and is supplemented with the DEQ station 10375 with data collected partially during September, October, and November. All LASAR stations (26749, 26750, and 29644) used previously in the calibration during 2001/2002 do not have data for 2015/2016. Two new calibration stations were identified that had limited data (data was only available during September, October, and November).")}`

`r if(waterbody_name == "Long Tom River"){paste0("The current condition calibration parameters (i.e. from 2001/2002) may need to be updated in the 2015 model to reflect spawning period conditions.  Potential calibration adjustments may be made to Manning’s coefficient , wind sheltering, evaporation, and sediment temperatures. Vegetative and topographic shade characteristics will not be adjusted since the model input was developed using a detailed GIS analysis. The model calibration location and available data during the years 2015 are shown below in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),".")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Model calibration will focus on flow, water level, and water temperature data from calibration sites that have available data during the simulation period.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("Hydrodynamic calibration data are available during 2015 for each of the six water level observation and one flow calibration station used during 2001/2002.  Out of the 17 water temperature stations used previously in 2001/2002, only 3 stations have data during the year 2015 and/or 2016.  Several of the water temperature stations were from Oregon’s Laboratory Analytical Storage and Retrieval Database (LASAR) and have an associated ID which is similar to the LASAR but only have data during either 2001 and/or 2002 but no data collected during 2015 and/or 2016.")}`

`r if(waterbody_name == "Willamette River: Lower"){paste0("The current condition calibration parameters (i.e. from 2001/2002) may need to be updated in the 2015 model to reflect spawning period conditions.  Potential calibration adjustments may be made to Manning’s coefficient , wind sheltering, evaporation, and sediment temperatures. Vegetative and topographic shade characteristics will not be adjusted since the model input was developed using a detailed GIS analysis. The model calibration location and available data during the years 2015 are shown below in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),".")}`

`r if(waterbody_name %in% c("Clackamas River","Long Tom River","Willamette River: Lower")){if(!model.extent == TRUE) {paste(chap6x7, collapse = "\n")} else {if(NROW(t6x7)>0){t6x7_tbl}}}`

`r if(waterbody_name %in% c("Coast Fork and Middle Fork Willamette River","McKenzie River: Lower","North Santiam and Santiam River","South Santiam River","Willamette River: Middle","Willamette River: Upper")){paste0("[Update:] The model calibration is documented in the USGS report (citation).")}`
