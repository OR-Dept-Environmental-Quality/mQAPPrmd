---
output: 
  word_document:
    reference_docx: T:/Temperature_TMDL_Revisions/model_QAPPs/R/data/rmd_template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r, label=`setup-chap6`, include=FALSE}
knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)
options(kableExtra.auto_format = F)
options(knitr.kable.NA = '')

# for test: waterbody_name <- "Johnson Creek (2002)"

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

model.extent <- ifelse(NROW(section.model.input)>0,
                       ifelse(section.model.input$`Model Waterbody` == section.model.input$`Model Extent`, TRUE, FALSE),
                       TRUE)

model.extent <- na.omit(model.extent)

```

## `r waterbody_name`

`r if(!waterbody_name %in% "Columbia Slough (1992)"){paste0("The ", waterbody_name, " model is a ", tolower(ifelse(unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Primary Model Parameter") == "Solar", "shade",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Primary Model Parameter")))," model developed using ",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Model version"),". The model ",if(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"New Model" %in% "T"){paste0("will be")}else{paste0("was")}," developed by ",unique(section.model.info[which(section.model.info$"Model Waterbody" == waterbody_name),]$"Calibration Org"),".")}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("The Columbia Slough CE-QUAL-W2 model setup and calibration were conducted by Portland State University and documented in Wells and Berger, 1995; Berger, 2003; Berger and Wells, 2005; and DEQ, 2006. The model used for the temperature TMDL development was a modified version of a previous series of calibrated CE-QUAL-W2 models that had been developed for the Columbia Slough by Portland State University for the City of Portland Bureau of Environmental Services (Wells and Berger, 1995; Berger and Wells, 1999).")}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("The modified model for the TMDL included a shorter period of simulation focusing on the summer season in the year 1992. This change was made to focus on the period when temperature data were available. The model also included additional macrophyte and shading algorithms. Features of the macrophyte model include the ability to simulate multiple submerged macrophyte species; the transport of nutrient fluxes between plant biomass and the water column and/or sediments; growth limitation due to nutrient, light and temperature; the simulation of the spatial distribution of macrophytes vertically and horizontally; the modeling of light attenuation in the water column caused by macrophyte concentration; and the modeling of channel friction due to macrophytes. Macrophyte growth can significantly affect temperatures in the Columbia Slough because the greater channel friction raises water levels and increases travel time. The amount of shade predicted by the model was based upon DEQ vegetation and land cover classifications provided to Portland State University (DEQ, 2006).")}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("Conditions affecting water temperature in the Columbia Slough have changed significantly since the 1992 model calibration period (MCDD, personal communication June 2021; CSWC, 2013). These changes include the removal or replacement of multiple culverts; replacement of older pumps with new ones that have increased pumping capacity; removal of the weir and control structure at the outlet of Bybee Lake; channel modification and channel dredging in the Middle and Upper Slough; riparian replanting; and changes to flow management. All these changes are expected affect water level, flow rate, and water temperature. Due to the extensive changes in the system, DEQ believes the existing model should be updated and recalibrated before it is used for simulation of current water temperature conditions and new management scenarios. DEQ investigated, to the extent that time allowed, some of the model setup changes required for recalibration. This summary, found in Appendix D, is not exhaustive and should be treated as a starting point. Based on this initial investigation, it was determined that a recalibration of the Columbia Slough model will require an effort and timeline that likely does not align with the project schedule or available resources. The Columbia Slough model is a complex system and DEQ is concerned that an attempt to proceed with a recalibration would put the project at risk of missing critical court mandated deadlines. For this reason, the existing Columbia Slough CE-QUAL-W2 model will not be updated or used for new management scenarios at this time. The implication of this decision is that it will not be possible to quantify the amount of warming caused by anthropogenic activities separate from the warming caused by background sources. As a result, the TMDL may be more general and lump all nonpoint sources into a general nonpoint source load allocation. The existing calibrated model is summarized in this section to document its existence and that it was considered for TMDL development.")}`

### Model domain

```{r, label=`t6x1`, include=FALSE}
  
  model.domain <- unique(sort(section.model.info$`Model Extent Text`))

```

The extent of the model domain is `r model.domain` `r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("The model extent is shown in Figure 3 through Figure 6 (extracted from Berger and Wells, 2005) and also included in the HTML interactive map that accompanies this QAPP and is referenced in Appendix D.")}else{paste0("The model extent is shown in the HTML interactive map that accompanies this QAPP and is referenced in Appendix C.")}`

```{r cs_lower_west, eval.after="fig.cap", fig.cap=cs.lower.west, results='asis', cache=FALSE, eval=TRUE, fig.height=7, out.height='615px', echo=FALSE}

cs.lower.west <- figs(name="cs.lower.west", caption = paste0("Columbia Slough (1992) model segments for the west end of the Lower Columbia Slough (Berger and Wells, 2005)."))

if(waterbody_name %in% "Columbia Slough (1992)"){

  knitr::include_graphics(path = "./fig/Columbia_Slough_lower_west_model_domain.JPG")
  
}

```

```{r cs_lower_east, eval.after="fig.cap", fig.cap=cs.lower.east, results='asis', cache=FALSE, eval=TRUE, fig.height=7, out.height='615px', echo=FALSE}

cs.lower.east <- figs(name="cs.lower.east", caption = paste0("Columbia Slough (1992) model segments for the east end of the Lower Columbia Slough (Berger and Wells, 2005)."))

if(waterbody_name %in% "Columbia Slough (1992)"){
  
  knitr::include_graphics(path = "./fig/Columbia_Slough_lower_east_model_domain.JPG")
  
}

```

```{r cs_mid_west, eval.after="fig.cap", fig.cap=cs.mid.west, results='asis', cache=FALSE, eval=TRUE, fig.height=7, out.height='615px', echo=FALSE}

  
cs.mid.west <- figs(name="cs.mid.west", caption = paste0("Columbia Slough (1992) model segments for the west end of the Middle Columbia Slough (Berger and Wells, 2005)."))

if(waterbody_name %in% "Columbia Slough (1992)"){
  
  knitr::include_graphics(path = "./fig/Columbia_Slough_middle_west_model_domain.JPG")
  
}

```

```{r cs_mid_east, eval.after="fig.cap", fig.cap=cs.mid.east, results='asis', cache=FALSE, eval=TRUE, fig.height=7, out.height='615px', echo=FALSE}

  
cs.mid.east <- figs(name="cs.mid.east", caption = paste0("Columbia Slough (1992) model segments for the east end of the Middle Columbia Slough and the Upper Slough (Berger and Wells, 2005)."))

if(waterbody_name %in% "Columbia Slough (1992)"){

  knitr::include_graphics(path = "./fig/Columbia_Slough_middle_east_upper_model_domain.JPG")
  
}

```

### Spatial and temporal resolution

```{r, label=`resol`, include=FALSE}
# test: waterbody_name <-  "Columbia Slough (1992)"
data.dir <- "//deqhq1/TMDL/Planning statewide/Temperature_TMDL_Revisions/model_QAPPs/R/data/"
col.slough <- readxl::read_xlsx(paste0(data.dir,"tables_LowerWillamette.xlsx"),sheet = "LowerWillamette_ColumbiaSlough")

if(waterbody_name %in% "Columbia Slough (1992)"){
  
  tbl.col.slough <- flextable::regulartable(col.slough) %>% 
    flextable::set_table_properties(layout = "autofit") %>% 
    flextable::valign(valign = "top") %>% 
    flextable::theme_box() %>% 
    flextable::set_caption(tbls(name = "col.slough",
                                caption = paste0("Model characteristics of the Columbia Slough CE-QUAL-W2 grids.")))
  
}

```

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("The Columbia Slough (1992) model is composed of 397 longitudinal segments (25-231 meters in length), 17 vertical layers (layer height of 0.30-0.61 meters), and 41 branches (separate water bodies or branches off the main stem), many of which are segregated by culverts. The number of model time step intervals (NDT) is 2 and the minimum time step (DLTMIN) is 0.025 seconds. The maximum timestep (DLTMAX) is 20 seconds. The characteristics of the Columbia Slough (1992) model regions are shown in Table 17. For additional details regarding model setup and resolution, see Berger and Wells, 2005.")}`

`r if(!waterbody_name %in% "Columbia Slough (1992)"){paste0("The model input spatial resolution (*dx*) is ", unique(section.model.info$"Input dx"), " ", unique(section.model.info$"Input dx Units"), ". Outputs are generated every ", unique(section.model.info$"Output dx"), " ", unique(section.model.info$"Output dx Units"), ". The model time step (*dt*) is ", unique(section.model.info$dT), " ", unique(section.model.info$"dT Units")," and outputs are generated every hour.")}`

`r if(!waterbody_name %in% "Columbia Slough (1992)"){paste0("A *dx* of ", unique(section.model.info$"Input dx"), " ", unique(section.model.info$"Input dx Units"), " was chosen to capture the range of solar flux input caused by the varied vegetation conditions along the length of the stream. The high resolution *dx* will allow evaluation of multiple vegetation management scenarios for each designated management agency.")}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){tbl.col.slough}`

### Source characteristics

```{r, label=`sc`, include=FALSE}

# NPDES
npdes.ind.waterbody <- npdes.ind.pro.area %>%
  dplyr::filter(grepl(pattern=gsub("\\s*\\([^\\)]+\\)","",x=waterbody_name), x=`Stream Name`, ignore.case = TRUE)) %>% 
  dplyr::mutate(`Facility Name (Facility Number)` = paste0(`Common Name`," (", `WQ File Nbr`,")"),
                `Latitude/Longitude` = paste0(round(Latitude,4), "/",round(Longitude,3)),
                `Permit Type and Description` = paste0(`Permit Type`, ": ", `Permit Description`),
                `River Mile` = round(`River Mile`,1),
                `Stream/River Mile` = ifelse(is.na(`Stream Name`), NA, paste0(`Stream Name`, " ", " RM ",`River Mile`))) %>% 
  dplyr::select(`Facility Name (Facility Number)`, `Latitude/Longitude`,`Permit Type and Description`, `Stream/River Mile`) %>% 
  dplyr::arrange(`Facility Name (Facility Number)`)

npdes.ind.n <- nrow(npdes.ind.waterbody)

if(npdes.ind.n>0){
  
  if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){
    
    npdes.ind.tbl <- knitr::kable(npdes.ind.waterbody, format = "pandoc", padding = 2,
                                  caption = tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),
                                                 caption = paste0("Summary of individual NPDES permitted discharges in the ", waterbody_name, ".")))
    
  }
  
}

if(npdes.ind.n == 0) {
  npdes.txt <- "There are no permitted individual NPDES point sources along the model extent."
} 

if(npdes.ind.n == 1) {
  npdes.txt <- paste0("There is one permitted individual NPDES point source along the model extent. Detail about the point source is summarized in ",if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite")}, ".")
}

if(npdes.ind.n > 1) {
  npdes.txt <- paste0("There are ", numbers.to.words(npdes.ind.n)," permitted individual NPDES point sources along the model extent. Detail about each point source is summarized in ",if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){tbls(name = paste0("npdes.ind.waterbody_",waterbody_name),display="cite")},".")
} 

# NLCD
nlcd.waterbody <- nlcd.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(NLCD_Land,Acres,Percentage) %>% 
  dplyr::rename("2016 NLCD Land Cover" = NLCD_Land,
                "Percent of Total Acres" = Percentage)

if(NROW(nlcd.waterbody)>0){
  
  if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){
    
    nlcd.wb.tbl <- knitr::kable(nlcd.waterbody, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("nlcd.waterbody_",waterbody_name),
                                               caption = paste0("Summary of land uses within 100 meters of the digitized ", waterbody_name, " centerline based on the 2016 National Land Cover Database (Yang et al 2018).")))
    
  }
}

nlcd.text.waterbody <- nlcd.text.pro.area %>% 
  dplyr::filter(Stream == waterbody_name)

# DMA
dma.waterbody <- dma.pro.area %>% 
  dplyr::filter(Stream == waterbody_name) %>% 
  dplyr::select(DMA_RP,Acres,Percentage) %>% 
  dplyr::rename("DMA or Responsible Person" = DMA_RP,
                "Percent of Total Acres" = Percentage) 

if(NROW(dma.waterbody)>0){
  
  if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){
    
    dma.wb.tbl <- knitr::kable(dma.waterbody, format = "pandoc", padding = 2,
                               caption = tbls(name = paste0("dma.waterbody",waterbody_name),
                                              caption = paste0("Summary of designated management agencies (DMAs) or responsible persons within 100 meters of the digitized ", waterbody_name, " centerline.")))
    
  }
  
}

```

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("The primary sources of thermal loading contributing to temperatures exceedances along the Columbia Slough include increases in solar radiation loading from the disturbance or removal of near-stream vegetation, point source discharges, channel modification, flow management, and background sources (Wells and Berger, 1995; Berger, 2003; DEQ, 2006). Other potential sources include warming caused by climate change.")}`

`r if(waterbody_name %in% "Columbia Slough Subwatershed (2019)"){paste0("For the discussion of source characteristics, see Section 6.3.3 for the existing Columbia Slough (1992) model.")}`

`r if(waterbody_name %in% "Johnson Creek (2002)"){paste0("The primary sources of thermal loading contributing to temperatures exceedances along the Johnson Creek include increases in solar radiation loading from the disturbance or removal of near-stream vegetation, channel modification, reductions to stream flow, and background sources (DEQ, 2006). Inline ponds, which are small ponds within the stream channel created by small dams, are also a source of increased temperatures (Holzer, 2020). There are at least 70 inline ponds in the Johnson Creek watershed. Other potential sources include warming caused by climate change.")}`

`r if(waterbody_name %in% c("Johnson Creek Watershed (2019)","Tualatin Mountains (2019)","Tryon Creek Watershed (2019)")){paste0("The primary purpose of the ", waterbody_name," shade model is to characterize solar radiation loading and the amount of effective shade. Effective shade is a surrogate for solar radiation loading caused by the disturbance or removal of near-stream vegetation. Other potential sources of thermal loading will not evaluated by this model.")}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("Over the years the Slough system has been extensively dredged, diked, filled and channelized, principally by the U.S. Army Corps of Engineers, the City of Portland, and the Port of Portland. Originally a series of wetlands and marshes created by annual flooding of the Columbia and Willamette Rivers, the Slough is now a highly managed water system with dikes, levees, pipes, culverts, and pumps to provide watershed drainage and flood control for the lowlands surrounding it. Multnomah County Drainage District (MCDD) manages this complex set of infrastructure. The district also clears debris and other blockages within the system.  Due to the extensive modifications to the Columbia Slough, water no longer drains naturally, but relies on two primary pump stations that lift water over the levees, and into the Columbia River or lower Columbia Slough which drains to the Willamette River. The hydraulic management of the Slough can have a significant impact on the water quality and the uses supported by the Slough (Wells and Berger ,1995; Berger, 2003; DEQ, 2006).")}`

`r if(!waterbody_name %in% c("Johnson Creek Watershed (2019)","Columbia Slough Subwatershed (2019)","Tualatin Mountains (2019)","Tryon Creek Watershed (2019)")){npdes.txt}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){if(npdes.ind.n > 0){npdes.ind.tbl}}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){paste0("The majority land use",if(NROW(nlcd.text.waterbody)>0){s(nlcd.text.waterbody$n)}," along the ",waterbody_name," ",if(NROW(nlcd.text.waterbody)>0){is.are(nlcd.text.waterbody$n[1])}," ",if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$text}," accounting for about ",if(NROW(nlcd.text.waterbody)>0){nlcd.text.waterbody$MajorityPercent}," percent of the near stream area. ",if(NROW(nlcd.waterbody)>0){tbls(name = paste0("nlcd.waterbody_",waterbody_name),display="cite")}," summarizes all the land uses within 100 meters of the digitized ",waterbody_name," centerline. Land uses were summarized using the 2016 National Land Cover Database (Yang et al 2018).")}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){if(NROW(nlcd.waterbody)>0){nlcd.wb.tbl}}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){paste0("Anthropogenic related stream warming caused by nonpoint sources is closely associated with the uses, activity, and the condition of vegetation adjacent to the stream. How activities and uses are managed in these areas is partially determined by a variety of different rules and management plans established by the landowner and any agency with land use authority. To better understand the spatial distribution of different agency rules or management plans along the model extent DEQ mapped known designated management agencies.")}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){paste0("A designated management agency is defined in OAR 340-042-0030(2) as a federal, state, or local governmental agency that has legal authority over a sector or source contributing pollutants. Typically, persons or designated management agencies that are identified in the TMDL Water Quality Management Plan (WQMP) are responsible for developing TMDL implementation plans and implementing management strategies to reduce pollutant loading. ",if(!waterbody_name %in% "Tualatin Mountains (2019)"){tbls(name = paste0("dma.waterbody",waterbody_name),display="cite")}," summarizes the potential designated management agencies and responsible persons along the ",waterbody_name," model extent. ",if(waterbody_name %in% "Columbia Slough (1992)"){paste0("This table is based on land ownership and does not include special districts like the MCDD. The MCDD area overlaps with much of the Columbia Slough.")})}`

`r if(!waterbody_name %in% "Columbia Slough Subwatershed (2019)"){if(NROW(dma.waterbody)>0){dma.wb.tbl}}`

### Time frame of simulation

```{r, label=`tf`, include=FALSE}

model_period_start <- as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30")
model_period_end <- as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30")

```

`r if(as.integer(as.numeric(as.Date(model_period_start))) == as.integer(as.numeric(as.Date(model_period_end)))){paste0("The model period is for a single day: ",format(model_period_start, format="%B %d, %Y"),".")}else{paste0("The model period is ", format(model_period_start, format="%B %d, %Y"), " to ", format(model_period_end, format="%B %d, %Y"), ".")}`

### Important assumptions

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("Key calibration assumptions made during the model setup and calibration process were documented in the original TMDL (DEQ, 2006), the model setup and calibration documentation (Wells and Berger 1995; Berger and Wells 2005), and the CE-QUAL-W2 user guide (Cole and Wells, 2000).")}`

`r if(waterbody_name %in% "Johnson Creek (2002)"){paste0("The effort currently described in the QAPP includes use of existing models. Key calibration assumptions made during the model setup and calibration process were documented in the original TMDL (DEQ, 2006).")}`

`r if(waterbody_name %in% c("Johnson Creek Watershed (2019)","Columbia Slough Subwatershed (2019)","Tualatin Mountains (2019)","Tryon Creek Watershed (2019)")){paste0("Model development for the ",waterbody_name," will be completed by City of Portland Bureau of Environmental Services. Model development assumptions are expected to be documented in the City of Portland final model report. DEQ will review the model and model assumptions and include or reference them in the TMDL. Other key assumptions about model constants are described in the Heat Source model user guide (Boyd and Kasper, 2003) or in Section 6 and Section 7 of this document.")}`

### Model inputs

```{r, label=`t6x6_1`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x6 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x6 <- c(chap6x6, knitr::knit_child(input = "chap6x6.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  if(!qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x6_met <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
      dplyr::group_by(`Station ID`,`Model Location Type`, `Location Units`, `Data Source`,Note) %>% 
      dplyr::summarize(`Model Location` = toString(unique(sort(round(`Model Location`,2)))),
                       Parameter = toString(unique(sort(Parameter))))%>% 
      dplyr::ungroup() %>%
      dplyr::rename(`Model Location Name (Station ID)` = `Station ID`,
                    `Input Type` = `Model Location Type`)
    
    t6x6_1 <- section.model.input %>% 
      dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")")),
                    `Model Location` = round(`Model Location`,2),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
      dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
      dplyr::rename(`Input Type` = `Model Location Type`) %>% 
      dplyr::arrange(`Input Type`,Parameter,desc(as.numeric(`Model Location`))) %>% 
      rbind(t6x6_met)
    
  }
  
  if(qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x6_met <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in%  c("Meteorological")) %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`))) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")"))) %>% # Willamette MS
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`, `Location Units`, `Model Location Type`, `Data Source`,Note) %>%    # Willamette MS
      dplyr::summarize(#`Model Location` = toString(unique(sort(round(`Model Location`,2)))),                                # Willamette MS
        Parameter = toString(unique(sort(Parameter))))%>% 
      dplyr::ungroup() %>%
      dplyr::rename(# `Model Location Name (Station ID)` = `Station ID`,                                                     # Willamette MS
        `Input Type` = `Model Location Type`)
    
    t6x6_1 <- section.model.input %>% 
      dplyr::filter(!`Model Location Type` %in%  c("Calibration Site", "Meteorological")) %>% 
      dplyr::mutate(`Model Location Name (Station ID)` = ifelse(`Station ID` %in% "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (", `Station ID`, ")")),
                    #`Model Location` = round(`Model Location`,2),                                                           # Willamette MS
                    `Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`),`Data Source`, paste0("Derived data. ",`Data Source`))) %>%  
      dplyr::select(`Model Location Name (Station ID)`, `Model Location`, `Location Units`, `Model Location Type`, `Parameter`, `Data Source`, Note) %>%
      dplyr::rename(`Input Type` = `Model Location Type`) %>% 
      dplyr::arrange(`Input Type`,Parameter,desc(`Model Location`)) %>% 
      rbind(t6x6_met)

    
  }
  
  t6x6_col <- t6x6_1 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x6_1)[names(t6x6_1) == "Model Location"] <- if(NROW(t6x6_col)>0){paste0("Model Location (",unique(t6x6_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x6_1 <- t6x6_1[,-c(3)] %>% 
    dplyr::rename(`Model Input` = Parameter)
  
  if(NROW(t6x6_1)>0){
    

    t6x6_1_tbl <-  knitr::kable(t6x6_1, format = "pandoc", padding = 2,
                                caption = tbls(name = paste0("t6x6_1", waterbody_name),
                                               caption = paste0("Boundary condition and tributary inputs to the existing ", waterbody_name, " Heat Source Model.")))
    
    
  }

}

```

`r if(!model.extent == TRUE){} else {if(NROW(t6x6_1)>0){paste0(tbls(name = paste0("t6x6_1", waterbody_name),display="cite")," summarizes the current configuration of the model input parameters and the source of these data. Temperature, flow, and meteorological input parameters are summarized to improve documentation of the TMDL approach.")}}`

`r if(!model.extent == TRUE){paste(chap6x6, collapse = "\n")}else{if(NROW(t6x6_1)>0){t6x6_1_tbl}}`

`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("For a complete description of model setup and inputs, see Wells and Berger (1995), and Berger and Wells (2005).")}`

`r if(waterbody_name %in% c("Johnson Creek Watershed (2019)","Columbia Slough Subwatershed (2019)","Tualatin Mountains (2019)","Tryon Creek Watershed (2019)")){paste0("The inputs to the model include LiDAR derived vegetation heights and stream position (latitude and longitude) derived from aerial imagery and LiDAR.")}`

```{r, label=`t6x6_2`, echo=FALSE}

t6x6_2 <- section.model.input %>%
  dplyr::filter(`Model Location Type` %in% "Meteorological")

```

`r if(NROW(t6x6_2)>1){paste0("Hourly meteorology inputs into the model include ", tolower(knitr::combine_words(unique(sort(t6x6_2$Parameter)))),". Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area.")}`

`r if(!is.na(unique(section.model.info$"Veg Notes"))){paste0("The near stream vegetation inputs to the model include vegetation height and canopy cover. ", unique(section.model.info$"Veg Notes"))}`

### Model calibration

```{r, label=`t6x7`, include=FALSE}
options(knitr.kable.NA = '') # hide NAs in table

if(!model.extent == TRUE){
  
  chap6x7 <- NULL
  
  for(model_extent in unique(sort(section.model.input$`Model Extent`))){
    
    chap6x7 <- c(chap6x7, knitr::knit_child(input = "chap6x7.Rmd", envir = globalenv()))
    
  }
  
} else {
  
  if(!qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x7 <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                    Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                    `Model Location` = round(`Model Location`,2),
                    `Model Location` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location`),
                    `Model Location Name` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location Name`),
                    `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                    `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (",`Station ID`,")")))%>% 
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`) %>% 
      dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
      dplyr::ungroup() %>% 
      dplyr::arrange(desc(as.numeric(`Model Location`))) %>% 
      dplyr::rename(`Calibration Parameter` = `Parameter`)
    
  }
  
  if(qapp_project_area == "Willamette River Mainstem and Major Tributaries"){
    
    t6x7 <- section.model.input %>% 
      dplyr::filter(`Model Location Type` %in% "Calibration Site") %>%
      dplyr::mutate(`Data Source` = ifelse(`Station ID` %in% "TIR", strip_alpha(`Data Source`), `Data Source`),
                    `Data Source` = ifelse(`Station ID` %in% "TIR", paste0(gsub(",.*$", "", `Data Source`)," (",stringi::stri_sub(`Data Source`,-4),")"), `Data Source`),
                    `Data Source` = ifelse(is.na(`Data Source`),"",`Data Source`),
                    `Data Source` = ifelse(is.na(`Interpolated Data`), `Data Source`,paste0("Derived data. ",`Data Source`)),
                    Parameter = ifelse(`Station ID` %in% "TIR", paste0(Parameter," (TIR)"), Parameter),
                    #`Model Location` = round(`Model Location`,2),
                    `Model Location` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location`),
                    `Model Location Name` = ifelse(`Station ID` %in% "TIR","Model extent",`Model Location Name`),
                    `Station ID` = ifelse(`Station ID` %in% "TIR",NA,`Station ID`),
                    `Model Location Name (Station ID)` = ifelse(`Station ID` == "No Station ID" | is.na(`Station ID`),
                                                                `Model Location Name`,
                                                                paste0(`Model Location Name`, " (",`Station ID`,")")))%>% 
      dplyr::group_by(`Model Location Name (Station ID)`,`Model Location`,`Location Units`,`Data Source`) %>% 
      dplyr::summarize(Parameter = toString(unique(sort(Parameter)))) %>% 
      dplyr::ungroup() %>% 
      dplyr::arrange(desc(`Model Location`)) %>% #
      dplyr::rename(`Calibration Parameter` = `Parameter`)
    
  }
  
  t6x7_col <- t6x7 %>% 
    dplyr::filter(!is.na(`Location Units`))
  
  names(t6x7)[names(t6x7) == "Model Location"] <- if(NROW(t6x7_col)>0){paste0("Model Location (",unique(t6x7_col$`Location Units`),")")}else{paste0("Model Location")}
  
  t6x7 <- t6x7[,c(1,2,5,4)]
  
  if(NROW(t6x7)>0){
    
    t6x7_tbl <- knitr::kable(t6x7, format = "pandoc", padding = 2,
                             caption = tbls(name = paste0("t6x7", waterbody_name),
                                            caption = paste0("Calibration sites and parameters used in the existing ", waterbody_name, " Heat Source Model.")))
    
    
    
  }
  
  mod.loc <- ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs7","hs8","hs9"),
                    print("The model location in the table below describes the distance of each input from the most downstream model node."),
                    ifelse(tmdl.mod.2[which(tmdl.mod.2$`Model Waterbody`== waterbody_name),]$mod_rmd %in% c("hs6"),
                           print("The model location in the table below describes the distance of each input from the most upstream model node."),
                           print("")))
  
  t6x7_1.txt <- "**[Update for CE-QUAL-W2 model]**"
  
}

```

#<<<<<<< master
`r if(!model.extent == TRUE){} else {if(NROW(t6x7)>0){paste0("The expected model calibration sites and data sources are summarized in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),". The model location in the table below describes the distance of each calibration site from the most downstream model node. The model inputs and parameters that are expected to be modified to improve model fit are described in Section 6.1.")}else{t6x7_1.txt}}`
#=======
`r if(waterbody_name %in% "Columbia Slough (1992)"){paste0("Model calibration was completed by PSU (Berger, 2003; Berger and Wells, 2005). Please refer to these reports for more information.")}`

`r if(waterbody_name %in% c("Johnson Creek Watershed (2019)","Columbia Slough Subwatershed (2019)","Tualatin Mountains (2019)","Tryon Creek Watershed (2019)")){paste0("Model calibration will be completed by the City of Portland Bureau of Environmental Services. DEQ and the City of Portland will coordinate and communicate on model development and quality assurance procedures outlined in this QAPP. The model will be calibrated primarily by comparing the model effective shade predictions to field measured effective shade values and canopy cover values measured with a densitometer by the City of Portland.  Canopy cover will be the primary calibration parameter. Other calibration parameters identified in Section 6.1.3 (landcover height and landcover overhang) will be determined directly from LiDAR with minimal adjustment. DEQ will review the model and model assumptions and recommend adjustments as necessary. The model and final calibration report will be made available to DEQ upon completion (COP BES personal communication August 2021).")}`

`r if(!model.extent == TRUE){} else {if(NROW(t6x7)>0){paste0("The expected model calibration sites and data sources are summarized in ",tbls(name = paste0("t6x7", waterbody_name),display="cite"),". The model location in the table below describes the distance of each input from the most downstream model node. The model inputs and parameters that are expected to be modified to improve model fit are described in Section 6.1.")}}`
#>>>>>>> Lower_Willamette_and_Clackamas_Subbasins

`r if(!model.extent == TRUE) {paste(chap6x7, collapse = "\n")} else {if(NROW(t6x7)>0){t6x7_tbl}}`
