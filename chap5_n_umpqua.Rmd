---
author: "yg"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output: 
  word_document:
    reference_docx: N:/Status_and_Trend_Reports/Report_Files/Report_Template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
---

```{r setup_chap5, include=TRUE}

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE,
                      cache = FALSE,
                      cache.comments = FALSE,
                      include = TRUE,
                      autodep = TRUE,
                      eval = TRUE
                      # fig.keep = 'all',
                      # fig.path = paste0(out_dir, "/Figures/"),
                      # fig.width = 12, 
                      # fig.height = 6
)

options(kableExtra.auto_format = F)

# For testing: waterbody_name <- "Canton Creek"

section.dta <- data %>% 
  dplyr::filter(section_name %in%  waterbody_name)

section.model.info <- model.info %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.model.input <- model.input %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name)

section.npdes <- npdes %>% 
  dplyr::filter(`Project Area` %in%  subbasin)%>% 
  dplyr::filter(`Stream Name` %in%  waterbody_name)

```

## `r waterbody_name`

### Source Characteristics

Temperature is the water quality parameter of concern, but heat, in particular heat from human activities or anthropogenic sources, is the pollutant of concern. Specifically, water temperature change is an expression of heat flux to waterbody (`r eqns(name = "temp_change", display="cite")`).   

$\Delta Temperature = \frac{\Delta Heat}{Density\times \text {Specific Heat}\times \Delta \text {Flow Volume}} \text { }$ (`r eqns(name = "temp_change", display="cite")`)

Stream temperature is influenced by natural factors such as climate, geomorphology, hydrology, and vegetation. Human or anthropogenic heat sources may include discharges of heated water to surface waters, increases solar radiation heat flux on the water’s surface due to the removal of near-stream vegetation and reductions in stream shading, changes to stream channel form, reductions in natural stream flows, and the reduction of coldwater inputs from groundwater. 

**[Update for each stream]** Canton Creek and its contributing watershed area is characterized as primarily a mix of private and federal forestlands. Vegetation removal from forest clear cutting is the dominant source of anthropogenic heat loads (ODEQ 2006). 

```{r t5x11, echo=FALSE, results='asis'}

if(NROW(section.npdes)>0){
  
  cat(paste0("There are ", NROW(section.npdes), " active individual NPDES permitted discharges on ", waterbody_name, "."))
  
} else {
    
  cat(paste0("There are no active individual NPDES permitted discharges on ", waterbody_name, "."))
  
}

```

### Data Availability and Quality

#### Meteorology
Meteorology inputs into the model include air temperature, cloudiness, relative humidity, and wind speed. The data source for these inputs is the National Climatic Data Center weather station at the Roseburg Regional Airport. Data may be adjusted to represent localized climate variability.

#### Continuous Stream Temperature Data

Continuous temperature data were collected at a number of locations during several years. `r tbls(name=paste0("t5x22_1", waterbody_name), display="cite")` lists all the locations where continuous stream temperature data were collected and the organizations that collected that data. `r tbls(name=paste0("t5x22_2", waterbody_name), display="cite")` summarizes when data were collected at each station. Specific uses for some of this temperature data are described in the model setup and calibration sections later in this report.

```{r t5x22_1, echo=FALSE, results='asis'}

st_awqms <- station_awqms %>% 
  dplyr::filter(section_name %in% waterbody_name) %>% 
  dplyr::filter(`Station ID` %in% unique(sort(section.dta$MLocID))) %>% 
  dplyr::select(`Station ID`, `Station Description`, Organization, Latitude, Longitude)

st_model <- station_model %>% 
  dplyr::filter(`Model Waterbody` %in%  waterbody_name) %>% 
  dplyr::filter(`Input Parameter` %in%  c("Water Temperature")) %>% 
  dplyr::mutate(`Station Description` = ifelse(is.na(`Station Description`),`Input Name`,`Station Description`),
                Organization = ifelse(is.na(Organization),`Data Source`,Organization)) %>% 
  dplyr::select(`Station ID`, `Station Description`, Organization, Latitude, Longitude)

t5x22_1 <- rbind(st_awqms,st_model) %>% 
  dplyr::group_by(`Station ID`,`Station Description`,Organization,Latitude,Longitude) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::select(-n) %>% 
  dplyr::arrange(`Station Description`)

if(NROW(t5x22_1)>0){
  print(knitr::kable(t5x22_1, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x22_1", waterbody_name),
                                    caption = paste0("Summary of active and historic continuous temperature monitoring locations in the ", waterbody_name, " Watershed currently available in public databases and DEQ files."))))
} else {
  
  cat(paste0("There are no active and historic continuous temperature monitoring locations in the ", waterbody_name, " Watershed currently available in public databases and DEQ files."))
  
}

```

```{r t5x22_2, echo=FALSE, results='asis'}
options(knitr.kable.NA = '')

t5x22_2 <- data.sample.count %>%
  dplyr::filter(section_name %in%  waterbody_name) %>% 
  dplyr::select(Year,`Station ID`,`Station Description`,Organization,
                Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec) %>% 
  dplyr::arrange(Year)

if(NROW(t5x22_2)>0){
  print(knitr::kable(t5x22_2, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x22_2", waterbody_name),
                                    caption = paste0("Summary of existing temperature data in the ", waterbody_name," Watershed. Columns Jan – Dec indicate the number of daily maximum temperature results in each month."))))
  
} else {
  
  cat(paste0("There is no existing temperature data in the ", waterbody_name," Watershed."))
  
}

```

#### Stream Flow Data

Flow volume data and other instream measurements were collected at several sites along `r waterbody_name` (`r tbls(name=paste0("t5x23_1", waterbody_name), display="cite")`) by Oregon DEQ. These measurements were used to develop flow mass balances for the `r waterbody_name` temperature model.

```{r t5x23_1, echo=FALSE, results='asis'}

t5x23_1 <- section.model.input %>% 
  dplyr::filter(`Input Parameter` %in% c("Flow")) %>% 
  dplyr::mutate(`Station Location` = ifelse(is.na(Latitude), `Station ID`, paste0(Latitude,", ", Longitude))) %>% 
  dplyr::select(`Input Name`, `Measurement Date`, `Station Location`, `Model Location`, `Data Source`) %>% 
  dplyr::rename(`Location Description` = `Input Name`,
                `Model Location (Kilometer)` = `Model Location`)

if(NROW(t5x23_1)>0){
  print(knitr::kable(t5x23_1, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x23_1", waterbody_name),
                                    caption = paste0("Instantaneous flow measurements in  ", waterbody_name, "."))))
  
} else {
  
  cat(paste0("There are no Instantaneous flow measurements in ", waterbody_name, "."))
  
}

```

Reliable streamflow data are important to model development, calibration and validation. The USGS maintain streamflow gages on the North Umpqua River, as well as major tributaries. Data are readily available from the USGS National Water Information System (NWIS), accompanied by useful QC information. 

```{r t5x23_2, echo=FALSE, results='asis'}

t5x23_2 <- usgs.station.tbl %>% 
  dplyr::filter(section_name %in%  waterbody_name) %>% 
  dplyr::select(-c(HUC10,section_name,n))

if(NROW(t5x23_2)>0){
  
  cat(paste0("There are ", NROW(t5x23_2), " USGS flow gaging stations on ", waterbody_name, " (",  tbls(name=paste0("t5x23_2", waterbody_name), display="cite"), ")."))

  print(knitr::kable(t5x23_2, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x23_2", waterbody_name),
                                    caption = paste0("USGS flow gaging stations in ", waterbody_name, "."))))
  
} else {
  
  cat(paste0("There are no USGS flow gaging stations on ", waterbody_name, "."))
  
}

```

#### Point Source Discharges

Measured flows and temperature data were used to determine the thermal loads from the point source discharges in the Heat Source models. ODEQ maintains a database (<http://www.deq.state.or.us/wq/sisdata/sisdata.asp>) for point source information.

```{r t5x24, echo=FALSE, results='asis'}

t5x24 <- section.npdes %>% 
  dplyr::mutate(`Facility Name and Number` = paste0(`Common Name`," (", `WQ File Nbr`,")"),
                `Permit Type and Description` = paste0(`Permit Type`, ": ", `Permit Description`),
                `Stream River Mile` = paste0(`Stream Name`, " ", " RM ",`River Mile`)) %>% 
  dplyr::select(`Facility Name and Number`, `Permit Type and Description`, `Stream River Mile`)

if(NROW(t5x24)>0){
  print(knitr::kable(t5x24, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x24", waterbody_name),
                                    caption = paste0("Summary of NPDES permitted discharges on ", waterbody_name, "."))))
  
} else {
  
  cat(paste0("There are no individually permitted point sources discharging heat to ", waterbody_name, "."))
  
}

```

#### Effective Shade Measurements

```{r t5x25, echo=FALSE, results='asis'}

t5x25 <- section.model.input %>% 
  dplyr::filter(`Input Parameter` %in% c("Effective Shade")) %>% 
  dplyr::mutate(`Station Location` = ifelse(is.na(Latitude), `Station ID`, paste0(Latitude,", ", Longitude))) %>% 
  dplyr::select(`Input Name`, `Measurement Date`, `Station Location`, `Model Location`, `Data Source`) %>% 
  dplyr::rename(`Location Description` = `Input Name`,
                `Model Location (Kilometer)` = `Model Location`)

if(NROW(t5x25)>0){
  
  cat(paste0("Effective shade data in ", tbls(name=paste0("t5x25", waterbody_name), display="cite"), " were collected to assist model calibration and simulation of incoming solar radiation. All effective shade measurements were collected with a Solar Pathfinder and correspond to solar paths observed during the months of July/August."))
  
  print(knitr::kable(t5x25, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x25", waterbody_name),
                                    caption = paste0("Effective shade data collected along  ", waterbody_name, "."))))
  
} else {
  
  cat(paste0("There are no effective shade data collected along ", waterbody_name, "."))
  
}

```

### Summertime Critical Period

#### Model Domain

```{r t5x31, include=TRUE, results='asis'}

if(length(section.model.info$`Model Extent Text`)>1){
  model.domain <- unique(sort(section.model.info$`Model Extent Text`))
} else {model.domain <- section.model.info$`Model Extent Text`} 

```
`r model.domain`

#### Spatial and Temporal Resolution

The length of the defined finite difference and data input sampling rate (dx) is `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")`. Output is generated every `r unique(section.model.info$"Output dx")` `r unique(section.model.info$"Output dx Units")`. The model time step (dt) is `r unique(section.model.info$dT)` `r unique(section.model.info$"dT Units")`.

A dx of `r unique(section.model.info$"Input dx")` `r unique(section.model.info$"Input dx Units")` was chosen to capture the range of solar flux input caused by the varied vegetation conditions along the length of the stream. The high resolution dx will also allow evaluation of vegetation multiple vegetation management scenarios for each designated management agency.

#### Time Frame of Simulation

The model period is `r format(as.Date(as.numeric(unique(section.model.info$"Model Period Start")), origin = "1899-12-30"), format="%B %d, %Y")` to `r format(as.Date(as.numeric(unique(section.model.info$"Model Period End")), origin = "1899-12-30"), format="%B %d, %Y")`.

#### Model Calibration

Model calibration was completed by DEQ and described in ODEQ (2006). Adjustments to the calibration model will not be made as part of this QAPP. Temperature, flow, and effective shade calibration sites, are summarized here to improve documentation of the TMDL approach.  If adjustments are made to the calibration model in the future, the QAPP will be amended to reflect the additional effort.

```{r t5x34, include=TRUE, results='asis'}

t5x34 <- section.model.input %>% 
  dplyr::filter(`Input Type` == "Calibration Site") %>% 
  dplyr::select(`Input Name`, `Model Location`, `Input Parameter`,  `Station ID`, `Data Source`) %>% 
  dplyr::rename(`Station Description` = `Input Name`,
                `Model Location (Kilometer)` = `Model Location`,
                `Model Input Type` = `Input Parameter`)

if(NROW(t5x34)>0){
  print(knitr::kable(t5x34, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x34", waterbody_name),
                                    caption = paste0("Calibration sites and parameters used in the existing ", waterbody_name, " Heat Source Model."))))
  
}

```

#### Model Inputs and Parameters

This section describes the input model parameters and those which will be most likely adjusted to improve calibration and fit. Adjustments to calibration model parameters will not be made as part of this QAPP. Temperature, flow, and meteorological input parameters are summarized here to improve documentation of the TMDL approach.  If adjustments are made to the calibration model in the future, the QAPP will be amended to reflect the additional effort.

```{r t5x35, include=TRUE, results='asis'}

t5x35 <- section.model.input %>% 
  dplyr::filter(!`Input Type` %in%  c("Calibration Site")) %>% 
  dplyr::select(`Input Name`, `Model Location`, `Input Parameter`,  `Station ID`, `Data Source`) %>%
  dplyr::rename(`Station Description` = `Input Name`,
                `Model Location (Kilometer)` = `Model Location`,
                `Model Input Type` = `Input Parameter`)

if(NROW(t5x35)>0){
  print(knitr::kable(t5x35, format = "pandoc", padding = 2,
                     caption = tbls(name = paste0("t5x35", waterbody_name),
                                    caption = paste0("Boundary condition inputs to the existing ", waterbody_name, " Heat Source Model."))))
  
}

```

Hourly meteorology inputs into the model include air temperature, cloudiness, relative humidity, and wind speed. The data source for these inputs is the National Climatic Data Center weather station at the Roseburg Regional Airport. Air temperature data were modified using the dry adiabatic lapse rate to adjust for differences in elevation between the measurement location and the model input location. Wind speeds were adjusted using a wind-sheltering coefficient to represent difference in wind speed between the measurement location and above the stream within the riparian area.

#### Data Gaps

Data gaps include:

* Tributary flow and temperature measurements for all tributary model inputs.  
* Measurements of withdrawals flow (if any) within the model extent.  
* The data source and quality for the following boundary condition inputs: `r paste(unique(sort(t5x35$"Station Description"), collapse = ", "))`. **[UPDATE FOR EACH STREAM]**

Data gaps were identified and addressed during original development of the `r waterbody_name` model. These approaches have not changed as the calibrated models are being used without refinements. If updates are made to the models in the future, this information will be updated and documented in an addendum to this QAPP. The modeling framework utilizes the best available data for setting up the model boundary conditions to provide a sound technical basis for TMDL analysis and evaluation of the temperature water quality standards.

#### Important Assumptions

Key assumptions made during collection, handling, transformation (harmonizing format and terms for compilation), and incorporation of data into the existing model was documented in the QAPP for the original modeling. The effort currently described in the QAPP includes use of existing models with no changes to the models since their previous calibration. 

### Spawning Period

####	Model Domain
####	Spatial and Temporal Resolution
####	Time Frame of Simulation
####	Model Calibration
####	Model Inputs and Parameters
####	Data Gaps
####	Important Assumptions